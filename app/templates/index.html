<!doctype html>
<meta charset="utf-8">
<title>å±Šå‡ºä½œæˆ</title>
<style>
  :root{
    --zone-hover-bg: #fff7cc;    /* ç›®ç«‹ã¤è–„ã„é»„è‰² */
    --zone-hover-bd: #ffb300;    /* æ¿ƒã„ã‚ã®é»„ã‚ªãƒ¬ãƒ³ã‚¸ */
    --zone-hover-shadow: rgba(255,179,0,0.25);
    --accent: #0b70ff;
  }
  html, body { height: 100%; }
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; margin:0; padding:0; box-sizing:border-box; background:#f8fafc; min-height:100vh; line-height:1.6;}
  .tabs{display:flex;gap:4px;margin-bottom:24px;background:#f8fafc;border-radius:12px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border:1px solid #e2e8f0;}
  .tab{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;user-select:none;font-weight:600;font-size:14px;color:#64748b;background:transparent;transition:all 0.2s ease;}
  .tab.active{background:#3b82f6;color:#ffffff;box-shadow:0 2px 4px rgba(59,130,246,0.3);}
  .hidden{display:none}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:24px;margin-bottom:24px;}
  .zone{border:2px dashed #e2e8f0;border-radius:12px;padding:24px;cursor:pointer;min-height:200px;background:#ffffff;transition:all 0.2s ease;position:relative;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
  .zone:hover,.zone.active{background:#f8fafc; border-color:#3b82f6; box-shadow:0 8px 16px rgba(0,0,0,0.1); transform:translateY(-1px);}
  .hint{color:#94a3b8;font-size:12px;margin-top:6px}
  .radios label{margin-right:10px}
  .toolbar{display:flex; gap:8px; margin:8px 0}
  .btn{padding:12px 20px; border:2px solid #3b82f6; border-radius:10px; background:#3b82f6; color:#ffffff; cursor:pointer; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; text-decoration:none; display:inline-block; box-shadow:0 2px 4px rgba(59,130,246,0.3);}
  .btn:hover{background:#2563eb; border-color:#2563eb; transform:translateY(-1px); box-shadow:0 4px 8px rgba(59,130,246,0.4);}
  #runBtn:hover{transform:translateY(-2px); box-shadow:0 15px 35px rgba(102,126,234,0.4);}
  .btn[disabled]{opacity:.55; cursor:not-allowed}
  td[contenteditable="true"]{background:#fffbe6}
  tr.selected{outline:2px solid #2ecc71}
  table{border-collapse:collapse; min-width:900px; width:100%;}
  th{background:#f8fafc; border:1px solid #e2e8f0; padding:12px 16px; font-size:14px; font-weight:600; color:#1e293b; text-align:left;}
  td{border:1px solid #e2e8f0; padding:12px 16px; font-size:14px; color:#374151;}
  /* DBå…¨ç”»é¢é«˜ã•ç”¨ã®ãƒ©ãƒƒãƒ‘ */
  .db-wrap{overflow:auto; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-top:16px; height: 50vh; background:#ffffff;}
  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ã‚¹ãƒ”ãƒŠãƒ¼ */
  .status{margin-left:10px; color:#555}
  .spinner{display:inline-block; width:1em; height:1em; border:2px solid #999; border-top-color:transparent; border-radius:50%; animation:spin .8s linear infinite; vertical-align:-2px; margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .progress{display:inline-block; min-width:80px}

  .filelist{display:flex; flex-direction:column; gap:8px; max-height:120px; overflow-y:auto; margin-bottom:12px;}
  .filechip{display:flex; align-items:center; gap:12px; padding:12px 16px; border:1px solid #e2e8f0; border-radius:12px; background:#ffffff; transition:all 0.2s cubic-bezier(0.4,0,0.2,1); box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  .filechip:hover{border-color:#667eea; background:#f8fafc; transform:translateY(-1px); box-shadow:0 4px 6px rgba(0,0,0,0.1);}
  .filechip svg{width:20px; height:20px; flex:0 0 auto; color:#10b981}
  .filechip .name{font-size:14px; color:#1a202c; font-weight:600; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
  .filechip .size{font-size:12px; color:#718096; font-weight:500;}
  .filechip .del{cursor:pointer; border:none; background:#fee2e2; color:#dc2626; font-size:12px; line-height:1; padding:6px 8px; border-radius:8px; transition:all 0.2s ease; font-weight:600;}
  .filechip .del:hover{background:#fecaca; transform:scale(1.05);}
  /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠç”»é¢ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .file-selection-chip{display:flex; flex-direction:column; gap:12px; padding:16px; border:1px solid #e2e8f0; border-radius:12px; background:#ffffff; transition:all 0.2s cubic-bezier(0.4,0,0.2,1); box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:16px;}
  .file-selection-chip:hover{border-color:#667eea; background:#f8fafc; transform:translateY(-1px); box-shadow:0 4px 6px rgba(0,0,0,0.1);}
  .file-selection-chip .file-header{display:flex; align-items:center; gap:12px; margin-bottom:12px;}
  .file-selection-chip .file-options{display:flex; flex-direction:column; gap:12px;}
  .file-selection-chip .option-row{display:flex; flex-direction:column; gap:6px;}
  .file-selection-chip .option-label{font-size:14px; font-weight:600; color:#374151;}
  .file-selection-chip .option-controls{display:flex; gap:8px;}
  .file-selection-chip .radio-group{display:flex; gap:8px; flex-wrap:wrap;}
  .file-selection-chip .radio-item{display:flex; align-items:center; gap:6px;}
  .file-selection-chip .radio-item input[type="radio"]{accent-color:#667eea;}
  .file-selection-chip .radio-item label{font-size:14px; font-weight:500; color:#4b5563; cursor:pointer;}
  .file-selection-chip select{width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; background:#ffffff;}
  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
  .modal-file-item{margin-bottom:24px; padding:20px; border:1px solid #e2e8f0; border-radius:12px; background:#f8fafc;}
  .modal-file-item .file-info{display:flex; align-items:center; gap:12px; margin-bottom:16px;}
  .modal-file-item .file-name{font-size:16px; font-weight:600; color:#1e293b;}
  .modal-file-item .file-size{font-size:14px; color:#64748b;}
  .modal-file-item .question-section{margin-bottom:16px;}
  .modal-file-item .question-label{font-size:14px; font-weight:600; color:#374151; margin-bottom:8px; display:block;}
  .modal-file-item .radio-group{display:flex; gap:12px; flex-wrap:wrap;}
  .modal-file-item .radio-item{display:flex; align-items:center; gap:6px;}
  .modal-file-item .radio-item input[type="radio"]{accent-color:#667eea;}
  .modal-file-item .radio-item label{font-size:14px; font-weight:500; color:#4b5563; cursor:pointer;}
  .modal-file-item select{width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; background:#ffffff;}
  .radio-label:hover{border-color:#667eea; background:#f8fafc; transform:translateY(-1px); box-shadow:0 4px 6px rgba(0,0,0,0.1);}
  .radio-label:has(input:checked){border-color:#667eea; background:linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%); box-shadow:0 4px 6px rgba(102,126,234,0.2);}
  select:hover{border-color:#667eea; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
</style>

<section id="panel-input">
  <div style="width:100%; padding:0 24px; margin-top:0;">
    <div style="background:#ffffff; border-radius:16px; padding:32px; box-shadow:0 4px 6px rgba(0,0,0,0.05); border:1px solid #e2e8f0;">
      <div class="tabs" style="margin-bottom:16px;">
        <div id="tab-input" class="tab active">ğŸ“ ä½œæˆ</div>
        <div id="tab-db" class="tab">ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</div>
      </div>
      <div id="input-content">
        <div style="text-align:center; margin-bottom:32px;">
          <div style="display:inline-flex; align-items:center; justify-content:center; width:56px; height:56px; background:#3b82f6; border-radius:12px; margin-bottom:16px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
          </div>
          <h1 style="font-size:28px; font-weight:700; color:#1e293b; margin:0 0 8px 0;">äº‹æ¥­è¨ˆç”»å¤‰æ›´å±Šå‡ºæ›¸ä½œæˆã‚·ã‚¹ãƒ†ãƒ </h1>
          <p style="color:#64748b; margin:0; font-size:16px;">é€£çµ¡æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€äº‹æ¥­è¨ˆç”»å¤‰æ›´å±Šå‡ºæ›¸ã‚’ç°¡å˜ã«ä½œæˆã§ãã¾ã™</p>
        </div>
        <form id="makeForm" enctype="multipart/form-data" onsubmit="return false;">
    <div class="grid">
      <div class="zone" id="incZone" tabindex="0">
        <div style="text-align:center; margin-bottom:16px;">
          <div style="display:inline-flex; align-items:center; justify-content:center; width:48px; height:48px; background:#10b981; border-radius:12px; margin-bottom:12px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17,8 12,3 7,8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
          </div>
          <h3 style="font-size:18px; font-weight:600; color:#1e293b; margin:0 0 4px 0;">â‘  é€£çµ¡æ›¸ï¼ˆå¢—è»Šï¼‰</h3>
          <p style="color:#64748b; font-size:14px; margin:0;">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ / ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</p>
        </div>
        <input id="incInput" type="file" name="increase_files" multiple accept=".xlsx" hidden>
        <label for="incInput" style="display:block; position:absolute; top:0; left:0; right:0; height:120px; cursor:pointer; z-index:1;"></label>
        <div style="margin-top:16px;">
          <div id="incList" class="filelist" aria-live="polite" style="margin-bottom:12px;"></div>
          <div style="font-size:12px; color:#718096; text-align:center;">åŒä¸€ä¼šç¤¾ãƒ»åŒä¸€æ‹ ç‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯ <span id="incCount" style="font-weight:600; color:#667eea;"></span></div>
        </div>
      </div>
      <div class="zone" id="decZone" tabindex="0">
        <div style="text-align:center; margin-bottom:16px;">
          <div style="display:inline-flex; align-items:center; justify-content:center; width:48px; height:48px; background:#f59e0b; border-radius:12px; margin-bottom:12px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7,10 12,15 17,10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </div>
          <h3 style="font-size:18px; font-weight:600; color:#1e293b; margin:0 0 4px 0;">â‘¡ é€£çµ¡æ›¸ï¼ˆæ¸›è»Šï¼‰</h3>
          <p style="color:#64748b; font-size:14px; margin:0;">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ / ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</p>
        </div>
        <input id="decInput" type="file" name="decrease_files" multiple accept=".xlsx" hidden>
        <label for="decInput" style="display:block; position:absolute; top:0; left:0; right:0; height:120px; cursor:pointer; z-index:1;"></label>
        <div style="margin-top:16px;">
          <div id="decList" class="filelist" aria-live="polite" style="margin-bottom:12px;"></div>
          <div style="font-size:12px; color:#718096; text-align:center;">åŒä¸€ä¼šç¤¾ãƒ»åŒä¸€æ‹ ç‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯ <span id="decCount" style="font-weight:600; color:#667eea;"></span></div>
        </div>
      </div>
    </div>

    <div style="margin-top:32px; text-align:center;">
      <button id="answerQuestionsBtn" style="background:#f59e0b; color:white; border:none; padding:16px 32px; font-size:16px; font-weight:600; border-radius:12px; cursor:pointer; transition:all 0.2s ease; box-shadow:0 4px 12px rgba(245,158,11,0.3); margin-right:16px;">
        <span style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          è³ªå•ã«ç­”ãˆã‚‹
        </span>
      </button>
      <button id="runBtn" disabled style="background:#94a3b8; color:white; border:none; padding:16px 32px; font-size:16px; font-weight:600; border-radius:12px; cursor:not-allowed; transition:all 0.2s ease; box-shadow:0 4px 12px rgba(148,163,184,0.3);">
        <span style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7,10 12,15 17,10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </span>
      </button>
        <div id="upStatus" style="margin-top:16px; font-weight:500; color:#64748b; font-size:14px;"></div>
      </div>
      </form>
      </div>

      <div id="db-content" class="hidden">
        <div style="text-align:center; margin-bottom:32px;">
          <div style="display:inline-flex; align-items:center; justify-content:center; width:56px; height:56px; background:#3b82f6; border-radius:12px; margin-bottom:16px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="9" x2="15" y2="9"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
          </div>
          <h1 style="font-size:28px; font-weight:700; color:#1e293b; margin:0 0 8px 0;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†</h1>
          <p style="color:#64748b; margin:0; font-size:16px;">ä¼šç¤¾ãƒ»å–¶æ¥­æ‰€ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã¨ç·¨é›†ãŒã§ãã¾ã™</p>
        </div>
        <div class="toolbar" style="position:sticky; top:0; background:#ffffff; z-index:10; padding:16px 0; margin-bottom:20px; border-bottom:1px solid #e2e8f0; display:flex; gap:12px; flex-wrap:wrap;">
          <button id="db-edit" style="padding:12px 20px; border:2px solid #3b82f6; border-radius:10px; background:#3b82f6; color:#ffffff; cursor:pointer; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(59,130,246,0.3);">ğŸ“ ç·¨é›†é–‹å§‹</button>
          <button id="db-save" disabled style="padding:12px 20px; border:2px solid #94a3b8; border-radius:10px; background:#94a3b8; color:#ffffff; cursor:not-allowed; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(148,163,184,0.3); opacity:0.6;">ğŸ’¾ ä¿å­˜</button>
          <button id="db-add-above" disabled style="padding:12px 20px; border:2px solid #94a3b8; border-radius:10px; background:#94a3b8; color:#ffffff; cursor:not-allowed; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(148,163,184,0.3); opacity:0.6;">â• é¸æŠè¡Œã®ä¸Šã«è¡Œã‚’è¿½åŠ </button>
          <button id="db-add" disabled style="padding:12px 20px; border:2px solid #94a3b8; border-radius:10px; background:#94a3b8; color:#ffffff; cursor:not-allowed; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(148,163,184,0.3); opacity:0.6;">â• è¡Œã‚’ä¸€ç•ªä¸‹ã«è¿½åŠ </button>
          <button id="db-del" disabled style="padding:12px 20px; border:2px solid #94a3b8; border-radius:10px; background:#94a3b8; color:#ffffff; cursor:not-allowed; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(148,163,184,0.3); opacity:0.6;">ğŸ—‘ï¸ é¸æŠè¡Œã‚’å‰Šé™¤</button>
          <a id="db-download" style="padding:12px 20px; border:2px solid #f59e0b; border-radius:10px; background:#f59e0b; color:#ffffff; cursor:pointer; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(245,158,11,0.3); text-decoration:none; display:inline-block;" href="/db/csv">ğŸ“Š CSV</a>
          <span id="db-msg" style="margin-left:12px; color:#64748b; font-weight:500;"></span>
        </div>
        <div id="mode-indicator" style="text-align:center; margin-bottom:16px; font-size:20px; font-weight:700; color:#3b82f6; padding:12px; background:#f8fafc; border-radius:8px; border:2px solid #e2e8f0;">
          é–²è¦§ãƒ¢ãƒ¼ãƒ‰
        </div>
        <div id="dbWrap" class="db-wrap" style="height:calc(100vh - 300px); overflow-y:auto;">
          <table id="db-table"></table>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- è³ªå•ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="questionModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); overflow-y:auto;">
  <div class="modal-content" style="background-color:#ffffff; margin:2% auto; padding:32px; border-radius:16px; width:90%; max-width:700px; max-height:90vh; box-shadow:0 8px 32px rgba(0,0,0,0.2); overflow-y:auto;">
    <div style="text-align:center; margin-bottom:32px;">
      <h2 style="font-size:24px; font-weight:700; color:#1e293b; margin:0 0 8px 0;">ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
      <p style="color:#64748b; margin:0; font-size:16px;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®åˆ¥ã¨ç©è¼‰ãƒˆãƒ³æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    </div>
    
    <div id="modalFileList" style="margin-bottom:32px;">
      <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
    </div>
    
    <div style="text-align:center;">
      <button id="modalCancelBtn" style="background:#6b7280; color:white; border:none; padding:12px 24px; font-size:14px; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s ease; margin-right:12px;">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
      <button id="modalConfirmBtn" style="background:#3b82f6; color:white; border:none; padding:12px 24px; font-size:14px; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s ease;">
        ç¢ºå®š
      </button>
    </div>
  </div>
</div>

<script>

// å®Ÿè¡ŒæˆåŠŸå¾Œã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é¸æŠã‚’åˆæœŸåŒ–ï¼ˆæˆåŠŸæ™‚ã®ã¿ï¼‰
function _clearFileInput(input){
  try{ input.value = ""; }
  catch(e){ const dt = new DataTransfer(); input.files = dt.files; }
}
function resetUploadsAfterSuccess(){
  if (window._incStore) _incStore.length = 0;
  if (window._decStore) _decStore.length = 0;
  const incInput = document.getElementById('incInput');
  const decInput = document.getElementById('decInput');
  const incList  = document.getElementById('incList');
  const decList  = document.getElementById('decList');
  const incCount = document.getElementById('incCount');
  const decCount = document.getElementById('decCount');
  if (incInput) _clearFileInput(incInput);
  if (decInput) _clearFileInput(decInput);
  if (typeof _syncAll === 'function'){
    _syncAll(incInput, _incStore, incList, incCount);
    _syncAll(decInput, _decStore, decList, decCount);
  }
}


// --- header/record key resolver (handles spaces/dots/full-width) ---
function _normHeader(s){
  return String(s||'').replace(/[\u3000\s\.]/g,'').replace(/ãƒ»/g,'');
}
function _buildKeyResolver(headers, records){
  const allKeys = new Set();
  (records||[]).forEach(r=>{ if(r) Object.keys(r).forEach(k=>allKeys.add(k)); });
  const keys = Array.from(allKeys);
  const res = {};
  headers.forEach(h=>{
    let use = h;
    if(!(records?.[0]||{})[h]){
      const nh = _normHeader(h);
      for(const k of keys){
        if(_normHeader(k) === nh){ use = k; break; }
      }
    }
    res[h] = use;
  });
  return res;
}


// ======== Multiple file stores & UI sync (non-breaking) ========
const _incStore = [];
const _decStore = [];

function _filesEqual(a,b){ return a.name===b.name && a.size===b.size && a.lastModified===b.lastModified; }

function _mergeFiles(store, files){
  const arr = Array.from(files||[]);
  arr.forEach(f=>{
    if(!store.some(x=>_filesEqual(x,f))) store.push(f);
  });
}

function _setInputFromStore(input, store){
  const dt = new DataTransfer();
  store.forEach(f=>dt.items.add(f));
  input.files = dt.files;
}

function renderFileListFromStore(listEl, store){
  console.log('renderFileListFromStoreå‘¼ã³å‡ºã—:', {
    listEl: listEl ? listEl.id : 'null',
    storeLength: store.length
  });
  if(!listEl) {
    console.log('listElãŒnullã§ã™');
    return;
  }
  listEl.innerHTML = '';
  store.forEach((f,idx)=>{
    console.log('ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ :', f.name, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', idx);
    const div = document.createElement('div');
    div.className = 'filechip';
    const size = formatFileSize(f.size);
    div.innerHTML = `<button class="del" data-idx="${idx}" aria-label="å‰Šé™¤" style="font-size:20px; padding:4px 8px; margin-right:8px;">Ã—</button>` + `<span class="name" title="${f.name}">${f.name}</span>` + `<span class="size">${size}</span>`;
    listEl.appendChild(div);
  });
  console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆæ›´æ–°å®Œäº†:', listEl.children.length, 'ä»¶');
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰è³ªå•å›ç­”çŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆ
  _questionAnswered = false;
  
  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
  updateRunButtonState();
}

function _syncAll(input, store, listEl, countEl){
  console.log('_syncAllå‘¼ã³å‡ºã—:', {
    storeLength: store.length,
    listEl: listEl ? listEl.id : 'null',
    countEl: countEl ? countEl.id : 'null'
  });
  // input.filesã¯æ›´æ–°ã—ãªã„ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
  fileCountBadge(input, countEl, store);
  renderFileListFromStore(listEl, store);
}

// è³ªå•ã«ç­”ãˆã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
document.addEventListener('DOMContentLoaded', ()=>{
  const answerQuestionsBtn = document.getElementById('answerQuestionsBtn');
  const questionModal = document.getElementById('questionModal');
  const modalCancelBtn = document.getElementById('modalCancelBtn');
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');
  
  // åˆæœŸçŠ¶æ…‹ã§ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
  updateRunButtonState();
  
  if(answerQuestionsBtn){
    answerQuestionsBtn.addEventListener('click', ()=>{
      // ã‚¹ãƒˆã‚¢ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
      const incFiles = Array.from(_incStore);
      const decFiles = Array.from(_decStore);
      
      if(incFiles.length === 0 && decFiles.length === 0){
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
      generateModalFileList(incFiles, decFiles);
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      questionModal.style.display = 'block';
    });
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  if(modalCancelBtn){
    modalCancelBtn.addEventListener('click', ()=>{
      questionModal.style.display = 'none';
    });
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºå®š
  if(modalConfirmBtn){
    modalConfirmBtn.addEventListener('click', ()=>{
      // å›ç­”ã‚’åé›†ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã«åæ˜ 
      collectAnswersAndUpdateDisplay();
      questionModal.style.display = 'none';
    });
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§ã¯é–‰ã˜ãªã„ï¼ˆç¢ºå®šãƒœã‚¿ãƒ³ã®ã¿ã§é–‰ã˜ã‚‹ï¼‰
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
function generateModalFileList(incFiles, decFiles){
  const modalFileList = document.getElementById('modalFileList');
  modalFileList.innerHTML = '';
  
  let fileIndex = 0;
  
  // å¢—è»Šãƒ•ã‚¡ã‚¤ãƒ«
  incFiles.forEach((file, idx) => {
    const fileDiv = createModalFileItem(file, fileIndex, 'increase');
    modalFileList.appendChild(fileDiv);
    fileIndex++;
  });
  
  // æ¸›è»Šãƒ•ã‚¡ã‚¤ãƒ«
  decFiles.forEach((file, idx) => {
    const fileDiv = createModalFileItem(file, fileIndex, 'decrease');
    modalFileList.appendChild(fileDiv);
    fileIndex++;
  });
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
function createModalFileItem(file, index, type){
  const div = document.createElement('div');
  div.className = 'modal-file-item';
  
  const size = formatFileSize(file.size);
  const typeLabel = type === 'increase' ? 'å¢—è»Š' : 'æ¸›è»Š';
  
  div.innerHTML = `
    <div class="file-info">
      <span class="file-name">${file.name}</span>
      <span class="file-size">${size}</span>
      <span style="background:#3b82f6; color:white; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600;">${typeLabel}</span>
    </div>
    
    <div class="question-section">
      <label class="question-label">â‘  ç¨®åˆ¥</label>
      <div class="radio-group">
        <div class="radio-item">
          <input type="radio" name="car_type_${index}" value="æ™®é€š" checked>
          <label>æ™®é€š</label>
        </div>
        <div class="radio-item">
          <input type="radio" name="car_type_${index}" value="å°å‹">
          <label>å°å‹</label>
        </div>
        <div class="radio-item">
          <input type="radio" name="car_type_${index}" value="ã‘ã‚“å¼•">
          <label>ã‘ã‚“å¼•</label>
        </div>
        <div class="radio-item">
          <input type="radio" name="car_type_${index}" value="è¢«ã‘ã‚“å¼•">
          <label>è¢«ã‘ã‚“å¼•</label>
        </div>
      </div>
    </div>
    
    <div class="question-section">
      <label class="question-label">â‘¡ ç©è¼‰ãƒˆãƒ³æ•°</label>
      <select name="weight_class_${index}">
        <option value="to_2t">2.0ãƒˆãƒ³ã¾ã§</option>
        <option value="2t_long">2.0ãƒˆãƒ³ãƒ­ãƒ³ã‚°</option>
        <option value="over_2t_long_to_7_5t">2.0ãƒˆãƒ³ãƒ­ãƒ³ã‚°è¶…ï½7.5ãƒˆãƒ³ã¾ã§</option>
        <option value="over_7_5t">7.5ãƒˆãƒ³ã‚’è¶…ãˆã‚‹ã‚‚ã®</option>
      </select>
    </div>
  `;
  
  return div;
}

// å›ç­”ã‚’åé›†ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã«åæ˜ 
function collectAnswersAndUpdateDisplay(){
  // ã‚¹ãƒˆã‚¢ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
  const incFiles = Array.from(_incStore);
  const decFiles = Array.from(_decStore);
  const allFiles = [...incFiles, ...decFiles];
  
  // å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å›ç­”ã‚’åé›†
  const fileAnswers = [];
  allFiles.forEach((file, index) => {
    const carTypeRadio = document.querySelector(`input[name="car_type_${index}"]:checked`);
    const weightSelect = document.querySelector(`select[name="weight_class_${index}"]`);
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡ã¯å…ƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆ†é¡ã‚’ä½¿ç”¨
    const fileType = incFiles.includes(file) ? 'increase' : 'decrease';
    
    fileAnswers.push({
      file: file,
      fileType: fileType,
      carType: carTypeRadio ? carTypeRadio.value : 'æ™®é€š',
      weightClass: weightSelect ? weightSelect.value : 'to_2t'
    });
  });
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºï¼‰
  updateFileListWithAnswers(fileAnswers);
}

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å›ç­”ä»˜ãã§æ›´æ–°
function updateFileListWithAnswers(fileAnswers){
  const incList = document.getElementById('incList');
  const decList = document.getElementById('decList');
  
  // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
  incList.innerHTML = '';
  decList.innerHTML = '';
  
  fileAnswers.forEach((answer, index) => {
    const div = document.createElement('div');
    div.className = 'filechip';
    const size = formatFileSize(answer.file.size);
    
    // ã‚¢ã‚¤ã‚³ãƒ³ã¨æƒ…å ±ã‚’è¡¨ç¤º
    const typeIcon = answer.fileType === 'increase' ? 'ğŸ“ˆ' : 'ğŸ“‰';
    const typeLabel = answer.fileType === 'increase' ? 'å¢—è»Š' : 'æ¸›è»Š';
    
    div.innerHTML = `
      <button class="del" data-file-index="${index}" aria-label="å‰Šé™¤" style="font-size:20px; padding:4px 8px; margin-right:8px;">Ã—</button>
      <span class="name" title="${answer.file.name}">${answer.file.name}</span>
      <span class="size">${size}</span>
      <span style="background:#3b82f6; color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600; margin-left:8px;">${typeLabel}</span>
      <span style="background:#10b981; color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600; margin-left:4px;">${answer.carType}</span>
      <span style="background:#f59e0b; color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600; margin-left:4px;">${getWeightLabel(answer.weightClass)}</span>
    `;
    
    if(answer.fileType === 'increase'){
      incList.appendChild(div);
    } else {
      decList.appendChild(div);
    }
  });
  
  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
  addDeleteListeners();
  
  // è³ªå•ã«ç­”ãˆãŸã“ã¨ã‚’è¨˜éŒ²
  _questionAnswered = true;
  
  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
  updateRunButtonState();
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã®è³ªå•å›ç­”çŠ¶æ³ã‚’è¿½è·¡ã™ã‚‹å¤‰æ•°
let _questionAnswered = false;

// ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateRunButtonState(){
  const runBtn = document.getElementById('runBtn');
  const incFiles = Array.from(_incStore);
  const decFiles = Array.from(_decStore);
  const allFiles = [...incFiles, ...decFiles];
  
  if(allFiles.length === 0 || !_questionAnswered){
    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã€ã¾ãŸã¯è³ªå•ã«ç­”ãˆã¦ã„ãªã„å ´åˆã¯ç„¡åŠ¹åŒ–
    runBtn.disabled = true;
    runBtn.style.background = '#94a3b8';
    runBtn.style.cursor = 'not-allowed';
    runBtn.style.boxShadow = '0 4px 12px rgba(148,163,184,0.3)';
  } else {
    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã€è³ªå•ã«ç­”ãˆãŸå ´åˆã¯æœ‰åŠ¹åŒ–
    runBtn.disabled = false;
    runBtn.style.background = '#3b82f6';
    runBtn.style.cursor = 'pointer';
    runBtn.style.boxShadow = '0 4px 12px rgba(59,130,246,0.3)';
  }
}

// å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
function addDeleteListeners(){
  const incList = document.getElementById('incList');
  const decList = document.getElementById('decList');
  
  // å¢—è»Šãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
  if(incList){
    incList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const fileIndex = +btn.dataset.fileIndex;
      if(Number.isInteger(fileIndex)){
                // ã‚¹ãƒˆã‚¢ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                _incStore.splice(fileIndex, 1);
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å†ç”Ÿæˆ
                const incFiles = Array.from(_incStore);
                const decFiles = Array.from(_decStore);
                const allFiles = [...incFiles, ...decFiles];
                
                if(allFiles.length === 0){
                  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ç©ºã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                  incList.innerHTML = '';
                  decList.innerHTML = '';
                  // ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
                  const incCount = document.getElementById('incCount');
                  const decCount = document.getElementById('decCount');
                  if(incCount) incCount.textContent = '';
                  if(decCount) decCount.textContent = '';
                } else {
                  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯å›ç­”ä»˜ãã§å†è¡¨ç¤º
                  const fileAnswers = [];
                  allFiles.forEach((file, index) => {
                    const carTypeRadio = document.querySelector(`input[name="car_type_${index}"]:checked`);
                    const weightSelect = document.querySelector(`select[name="weight_class_${index}"]`);
                    const fileType = incFiles.includes(file) ? 'increase' : 'decrease';
                    
                    fileAnswers.push({
                      file: file,
                      fileType: fileType,
                      carType: carTypeRadio ? carTypeRadio.value : 'æ™®é€š',
                      weightClass: weightSelect ? weightSelect.value : 'to_2t'
                    });
                  });
                  updateFileListWithAnswers(fileAnswers);
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚ŒãŸã‚‰è³ªå•å›ç­”çŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                _questionAnswered = false;
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateRunButtonState();
      }
    });
  }
  
  // æ¸›è»Šãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
  if(decList){
    decList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const fileIndex = +btn.dataset.fileIndex;
      if(Number.isInteger(fileIndex)){
                // ã‚¹ãƒˆã‚¢ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                _decStore.splice(fileIndex, 1);
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å†ç”Ÿæˆ
                const incFiles = Array.from(_incStore);
                const decFiles = Array.from(_decStore);
                const allFiles = [...incFiles, ...decFiles];
                
                if(allFiles.length === 0){
                  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ç©ºã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                  incList.innerHTML = '';
                  decList.innerHTML = '';
                  // ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
                  const incCount = document.getElementById('incCount');
                  const decCount = document.getElementById('decCount');
                  if(incCount) incCount.textContent = '';
                  if(decCount) decCount.textContent = '';
                } else {
                  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯å›ç­”ä»˜ãã§å†è¡¨ç¤º
                  const fileAnswers = [];
                  allFiles.forEach((file, index) => {
                    const carTypeRadio = document.querySelector(`input[name="car_type_${index}"]:checked`);
                    const weightSelect = document.querySelector(`select[name="weight_class_${index}"]`);
                    const fileType = incFiles.includes(file) ? 'increase' : 'decrease';
                    
                    fileAnswers.push({
                      file: file,
                      fileType: fileType,
                      carType: carTypeRadio ? carTypeRadio.value : 'æ™®é€š',
                      weightClass: weightSelect ? weightSelect.value : 'to_2t'
                    });
                  });
                  updateFileListWithAnswers(fileAnswers);
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚ŒãŸã‚‰è³ªå•å›ç­”çŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                _questionAnswered = false;
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateRunButtonState();
      }
    });
  }
}

// é‡é‡ã‚¯ãƒ©ã‚¹ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
function getWeightLabel(weightClass){
  const labels = {
    'to_2t': '2.0t',
    '2t_long': '2.0tL',
    'over_2t_long_to_7_5t': '2.0tL+',
    'over_7_5t': '7.5t+'
  };
  return labels[weightClass] || weightClass;
}

// ===============================================================

document.addEventListener('DOMContentLoaded', ()=>{
  const incInput = document.getElementById('increase_files') || document.getElementById('incInput');
  const decInput = document.getElementById('decrease_files') || document.getElementById('decInput');
  const incList  = document.getElementById('incList');
  const decList  = document.getElementById('decList');
  const incCount = document.getElementById('incCount');
  const decCount = document.getElementById('decCount');

  console.log('DOMè¦ç´ å–å¾—çŠ¶æ³:', {
    incInput: incInput ? incInput.id : 'null',
    decInput: decInput ? decInput.id : 'null',
    incList: incList ? incList.id : 'null',
    decList: decList ? decList.id : 'null',
    incCount: incCount ? incCount.id : 'null',
    decCount: decCount ? decCount.id : 'null'
  });

  // è¿½åŠ ãƒœã‚¿ãƒ³ã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€æ å†…ã‚¿ãƒƒãƒ—ã®ã¿ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ

  // æ—¢å­˜ change ã‚’æ‹¡å¼µï¼šæ–°è¦é¸æŠã‚’ store ã«ãƒãƒ¼ã‚¸
  if(incInput){
    incInput.addEventListener('change', (e)=>{
      console.log('å¢—è»Šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ:', e.target.files.length, 'ä»¶');
      if(e.target.files && e.target.files.length > 0){
        const beforeCount = _incStore.length;
        _mergeFiles(_incStore, e.target.files);
        const afterCount = _incStore.length;
        console.log('å¢—è»Šã‚¹ãƒˆã‚¢:', beforeCount, 'â†’', afterCount, 'ä»¶');
        _syncAll(incInput, _incStore, incList, incCount);
        // inputã‚’ã‚¯ãƒªã‚¢ã—ã¦æ¬¡å›ã®é¸æŠã‚’å¯èƒ½ã«ã™ã‚‹
        e.target.value = '';
      }
    });
  }
  if(decInput){
    decInput.addEventListener('change', (e)=>{
      console.log('æ¸›è»Šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ:', e.target.files.length, 'ä»¶');
      if(e.target.files && e.target.files.length > 0){
        const beforeCount = _decStore.length;
        _mergeFiles(_decStore, e.target.files);
        const afterCount = _decStore.length;
        console.log('æ¸›è»Šã‚¹ãƒˆã‚¢:', beforeCount, 'â†’', afterCount, 'ä»¶');
        _syncAll(decInput, _decStore, decList, decCount);
        // inputã‚’ã‚¯ãƒªã‚¢ã—ã¦æ¬¡å›ã®é¸æŠã‚’å¯èƒ½ã«ã™ã‚‹
        e.target.value = '';
      }
    });
  }

  // ãƒãƒƒãƒ—ã®Ã—ã§å‰Šé™¤ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
  if(incList){
    incList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const idx = +btn.dataset.idx;
      if(Number.isInteger(idx)){
        _incStore.splice(idx,1);
        _syncAll(incInput, _incStore, incList, incCount);
      }
    });
  }
  if(decList){
    decList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const idx = +btn.dataset.idx;
      if(Number.isInteger(idx)){
        _decStore.splice(idx,1);
        _syncAll(decInput, _decStore, decList, decCount);
      }
    });
  }

  // ã™ã§ã«ã‚ã‚‹ wireDrop() ã¯ input ã« files ã‚’ã‚»ãƒƒãƒˆã—ã¦ change ã‚’ç™ºç«ã™ã‚‹ã®ã§ã€
  // ã“ã“ã§ã® change ãƒãƒ³ãƒ‰ãƒ©ãŒ store ã«ãƒãƒ¼ã‚¸ã—ã€UIã¨ä»¶æ•°ã‚’æ›´æ–°ã—ã¾ã™ï¼ˆäº’æ›ç¶­æŒï¼‰ã€‚
  
  // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚’è¨­å®š
  wireDrop('incZone', 'incInput', _incStore, incList, incCount);
  wireDrop('decZone', 'decInput', _decStore, decList, decCount);
});

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function renderFileList(inputEl, listEl){
  if(!listEl) return;
  listEl.innerHTML = '';
  const files = Array.from(inputEl.files || []);
  if(files.length === 0){ return; }
  const icon = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2h7l5 5v15a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" fill="#059669"/><path d="M14 2v5h5" fill="#10b981"/></svg>`;
  files.forEach(f=>{
    const div = document.createElement('div');
    div.className = 'filechip';
    const size = formatFileSize(f.size);
    div.innerHTML = `<span class="name" title="${f.name}">${f.name}</span>` + `<span class="size">${size}</span>` + icon;
    listEl.appendChild(div);
  });
}

function wireDrop(zoneId, inputId, store, listEl, countEl){
  const zone = document.getElementById(zoneId);
  const input = document.getElementById(inputId);
  // zone.addEventListener('click', ()=> input.click()); // <label>ã¨ã®äºŒé‡ãƒˆãƒªã‚¬ã‚’é¿ã‘ã‚‹ãŸã‚å‰Šé™¤
  zone.addEventListener('focus', ()=> zone.classList.add('active'));
  zone.addEventListener('blur',  ()=> zone.classList.remove('active'));
  ['dragenter','dragover'].forEach(ev=>zone.addEventListener(ev, e=>{e.preventDefault(); zone.classList.add('active');}));
  ['dragleave','drop'].forEach(ev=>zone.addEventListener(ev, e=>{e.preventDefault(); zone.classList.remove('active');}));
  zone.addEventListener('drop', e=>{ 
    console.log('ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—:', e.dataTransfer.files.length, 'ä»¶');
    const beforeCount = store.length;
    _mergeFiles(store, e.dataTransfer.files);
    const afterCount = store.length;
    console.log('ã‚¹ãƒˆã‚¢æ›´æ–°:', beforeCount, 'â†’', afterCount, 'ä»¶');
    _syncAll(input, store, listEl, countEl);
  });
}
function fileCountBadge(input, badgeEl, store){
  const n = store?.length || 0;
  badgeEl.textContent = n ? `ï¼ˆ${n}ä»¶é¸æŠï¼‰` : '';
}
// wireDropã®å‘¼ã³å‡ºã—ã¯ã€DOMContentLoadedå†…ã§è¡Œã†

const tabInput = document.getElementById('tab-input');
const tabDb = document.getElementById('tab-db');
const inputContent = document.getElementById('input-content');
const dbContent = document.getElementById('db-content');

tabInput.addEventListener('click', ()=>{
  tabInput.classList.add('active'); tabDb.classList.remove('active');
  inputContent.style.display = 'block'; dbContent.style.display = 'none';
});

tabDb.addEventListener('click', async ()=>{
  tabDb.classList.add('active'); tabInput.classList.remove('active');
  dbContent.style.display = 'block'; inputContent.style.display = 'none';
  resizeDB(); await loadDB();
});

function resizeDB(){
  const wrap = document.getElementById('dbWrap');
  const top = wrap.getBoundingClientRect().top + window.scrollY;
  const paddingBottom = 24;
  const h = Math.max(300, window.innerHeight - (top - window.scrollY) - paddingBottom);
  wrap.style.height = h + 'px';
}
window.addEventListener('resize', resizeDB);

let DB = {headers:[], records:[]};
let editable = false;
let selectedRow = null;

async function loadDB(){
  document.getElementById('db-msg').textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';
  try{
    const res = await fetch('/db', {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const flat = await res.json();
    DB = {headers: flat.headers || [], records: flat.records || []};
    renderTable();
    document.getElementById('db-msg').textContent = `ãƒ˜ãƒƒãƒ€${DB.headers.length} / è¡Œ${DB.records.length}`;
  }catch(e){
    document.getElementById('db-msg').textContent = 'å–å¾—å¤±æ•—: ' + e.message;
  }
}

function renderTable(){
  const tbl = document.getElementById('db-table');
  const thead = `<thead><tr>${DB.headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const keyMap = _buildKeyResolver(DB.headers, DB.records);
  const tbody = `<tbody>${
    DB.records.map((r, idx)=>{
      const row = Array.isArray(r) ? r : DB.headers.map(h => (r?.[keyMap[h]] ?? ""));
      return `<tr data-idx="${idx}">` + row.map((c,i)=>{
        const h = DB.headers[i] || '';
        const ce = editable ? 'contenteditable="true"' : '';
        return `<td ${ce} data-col="${h}">${c ?? ''}</td>`;
      }).join('') + `</tr>`;
    }).join('')
  }</tbody>`;
  tbl.innerHTML = thead + tbody;
  tbl.querySelectorAll('tbody tr').forEach(tr=>{
    tr.addEventListener('click', ()=>{
      if(selectedRow) selectedRow.classList.remove('selected');
      selectedRow = tr; tr.classList.add('selected');
    });
  });
}

document.getElementById('db-edit').addEventListener('click', ()=>{
  editable = !editable;
  renderTable();
  const modeIndicator = document.getElementById('mode-indicator');
  const saveBtn = document.getElementById('db-save');
  const addAboveBtn = document.getElementById('db-add-above');
  const addBtn = document.getElementById('db-add');
  const delBtn = document.getElementById('db-del');
  
  if(editable){
    modeIndicator.textContent = 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
    modeIndicator.style.color = '#10b981';
    modeIndicator.style.borderColor = '#10b981';
    modeIndicator.style.background = '#f0fdf4';
    
    // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
    saveBtn.disabled = false;
    saveBtn.style.background = '#3b82f6';
    saveBtn.style.cursor = 'pointer';
    saveBtn.style.opacity = '1';
    
    addAboveBtn.disabled = false;
    addAboveBtn.style.background = '#10b981';
    addAboveBtn.style.cursor = 'pointer';
    addAboveBtn.style.opacity = '1';
    
    addBtn.disabled = false;
    addBtn.style.background = '#10b981';
    addBtn.style.cursor = 'pointer';
    addBtn.style.opacity = '1';
    
    delBtn.disabled = false;
    delBtn.style.background = '#10b981';
    delBtn.style.cursor = 'pointer';
    delBtn.style.opacity = '1';
  } else {
    modeIndicator.textContent = 'é–²è¦§ãƒ¢ãƒ¼ãƒ‰';
    modeIndicator.style.color = '#3b82f6';
    modeIndicator.style.borderColor = '#e2e8f0';
    modeIndicator.style.background = '#f8fafc';
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    saveBtn.disabled = true;
    saveBtn.style.background = '#94a3b8';
    saveBtn.style.cursor = 'not-allowed';
    saveBtn.style.opacity = '0.6';
    
    addAboveBtn.disabled = true;
    addAboveBtn.style.background = '#94a3b8';
    addAboveBtn.style.cursor = 'not-allowed';
    addAboveBtn.style.opacity = '0.6';
    
    addBtn.disabled = true;
    addBtn.style.background = '#94a3b8';
    addBtn.style.cursor = 'not-allowed';
    addBtn.style.opacity = '0.6';
    
    delBtn.disabled = true;
    delBtn.style.background = '#94a3b8';
    delBtn.style.cursor = 'not-allowed';
    delBtn.style.opacity = '0.6';
  }
});
document.getElementById('db-add-above').addEventListener('click', ()=>{
  if(!editable){ alert('ç·¨é›†é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  if(!selectedRow){ alert('è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const idx = parseInt(selectedRow.dataset.idx, 10);
  const empty = Object.fromEntries(DB.headers.map(h=>[h,'']));
  DB.records.splice(idx, 0, empty); 
  selectedRow = null; 
  renderTable();
});
document.getElementById('db-add').addEventListener('click', ()=>{
  if(!editable){ alert('ç·¨é›†é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  const empty = Object.fromEntries(DB.headers.map(h=>[h,'']));
  DB.records.push(empty); renderTable();
});
document.getElementById('db-del').addEventListener('click', ()=>{
  if(!editable){ alert('ç·¨é›†é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  if(!selectedRow){ alert('å‰Šé™¤ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if(!confirm('é¸æŠè¡Œã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  const idx = parseInt(selectedRow.dataset.idx, 10);
  DB.records.splice(idx, 1); selectedRow = null; renderTable();
});
document.getElementById('db-save').addEventListener('click', async ()=>{
  if(!editable){ alert('ç·¨é›†é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  const rows = Array.from(document.querySelectorAll('#db-table tbody tr'));
  DB.records = rows.map(tr=>{
    const tds = Array.from(tr.querySelectorAll('td'));
    const obj = {}; tds.forEach(td=> obj[td.dataset.col] = td.textContent); return obj;
  });
  try{
    const res = await fetch('/db/save', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(DB)});
    if(!res.ok){ throw new Error(await res.text()); }
    document.getElementById('db-msg').textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
    editable = false; await loadDB();
  }catch(e){
    alert('ä¿å­˜ã«å¤±æ•—: ' + e.message);
  }
});

// XHRã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—ã‚’è¡¨ç¤ºã—ã¤ã¤POSTâ†’å¿œç­”Blobã‚’ä¿å­˜
const runBtn = document.getElementById('runBtn');
const upStatus = document.getElementById('upStatus');
const form = document.getElementById('makeForm');

// ZIP signature quick check for .xlsx
async function isZip(file){
  const buf = await file.slice(0,4).arrayBuffer();
  const u = new Uint8Array(buf);
  return u[0]===0x50 && u[1]===0x4B && u[2]===0x03 && u[3]===0x04; // 'PK\x03\x04'
}

runBtn.addEventListener('click', async ()=>{

  const fd = new FormData();
  const upStatus = document.getElementById('upStatus');
  
  // ã‚¹ãƒˆã‚¢ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã¨å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const incFiles = Array.from(_incStore);
  const decFiles = Array.from(_decStore);
  const allFiles = [...incFiles, ...decFiles];
  
  if(allFiles.length === 0){
    upStatus.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
    return;
  }
  
  // .xlsx quick validation to prevent non-Excel uploads
  for(const f of allFiles){
    if(!(await isZip(f))){ 
      upStatus.textContent = 'å¤±æ•—: Excel(.xlsx)ä»¥å¤–ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'; 
      return; 
    }
  }
  
  // å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
  const fileAnswers = [];
  allFiles.forEach((file, index) => {
    const carTypeRadio = document.querySelector(`input[name="car_type_${index}"]:checked`);
    const weightSelect = document.querySelector(`select[name="weight_class_${index}"]`);
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡ã¯å…ƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆ†é¡ã‚’ä½¿ç”¨
    const fileType = incFiles.includes(file) ? 'increase' : 'decrease';
    
    fileAnswers.push({
      file: file,
      fileType: fileType,
      carType: carTypeRadio ? carTypeRadio.value : 'æ™®é€š',
      weightClass: weightSelect ? weightSelect.value : 'to_2t'
    });
  });
  
  // FormDataã«è¿½åŠ 
  let incIndex = 0;
  let decIndex = 0;
  
  fileAnswers.forEach((answer, index) => {
    if(answer.fileType === 'increase'){
      fd.append('increase_files', answer.file);
      fd.append(`inc_car_type_${incIndex}`, answer.carType);
      fd.append(`inc_weight_class_${incIndex}`, answer.weightClass);
      incIndex++;
    } else {
      fd.append('decrease_files', answer.file);
      fd.append(`dec_car_type_${decIndex}`, answer.carType);
      fd.append(`dec_weight_class_${decIndex}`, answer.weightClass);
      decIndex++;
    }
  });

  runBtn.disabled = true;
  upStatus.innerHTML = '<span class="spinner"></span><span class="progress" id="prog">å‡¦ç†ä¸­â€¦</span>';

  try{
    const blob = await xhrPostWithProgress('/process', fd, (percent)=>{
      const p = document.getElementById('prog');
      p.textContent = `å‡¦ç†ä¸­â€¦ ${percent}%`;
    });
    const fname = 'äº‹æ¥­è¨ˆç”»å¤‰æ›´å±Šå‡º.xlsx';
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = fname;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    resetUploadsAfterSuccess();
    
    upStatus.textContent = 'å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚';
    
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸå¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
    _incStore.length = 0;
    _decStore.length = 0;
    _questionAnswered = false;
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    const incList = document.getElementById('incList');
    const decList = document.getElementById('decList');
    if(incList) incList.innerHTML = '';
    if(decList) decList.innerHTML = '';
    
    // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
    const incCount = document.getElementById('incCount');
    const decCount = document.getElementById('decCount');
    if(incCount) incCount.textContent = '';
    if(decCount) decCount.textContent = '';
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    updateRunButtonState();
    
  }catch(e){
    upStatus.textContent = 'å¤±æ•—: ' + e.message;
  }finally{
    runBtn.disabled = false;
  }
});

function xhrPostWithProgress(url, formData, onProgress){
  return new Promise((resolve, reject)=>{
    const xhr = new XMLHttpRequest();
    xhr.open('POST', url);
    xhr.responseType = 'blob';
    xhr.upload.onprogress = (e)=>{
      if(e.lengthComputable && typeof onProgress === 'function'){
        const percent = Math.min(99, Math.round(e.loaded / e.total * 100));
        onProgress(percent);
      }
    };
    xhr.onload = ()=>{
      if(xhr.status >= 200 && xhr.status < 300){
        resolve(xhr.response);
      }else{
        const reader = new FileReader();
        reader.onload = ()=> reject(new Error(reader.result || ('HTTP '+xhr.status)));
        reader.readAsText(xhr.response);
      }
    };
    xhr.onerror = ()=> reject(new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'));
    xhr.send(formData);
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  const incWeight = document.getElementById('incWeight');
  const decHidden = document.getElementById('decWeightHidden');
  if(incWeight && decHidden){
    const sync = ()=>{ decHidden.value = incWeight.value; };
    incWeight.addEventListener('change', sync);
    sync();
  }
});

</script>
