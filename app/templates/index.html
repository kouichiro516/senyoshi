<!doctype html>
<meta charset="utf-8">
<title>届出作成</title>
<style>
  :root{
    --zone-hover-bg: #fff7cc;    /* 目立つ薄い黄色 */
    --zone-hover-bd: #ffb300;    /* 濃いめの黄オレンジ */
    --zone-hover-shadow: rgba(255,179,0,0.25);
    --accent: #0b70ff;
  }
  html, body { height: 100%; overflow-x: hidden; }
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; margin:0; padding:0; box-sizing:border-box; background:#f8fafc; min-height:100vh; line-height:1.6; overflow-x: hidden;}
  .tabs{display:flex;gap:4px;margin-bottom:24px;background:#f8fafc;border-radius:12px;padding:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border:1px solid #e2e8f0;}
  .tab{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;user-select:none;font-weight:600;font-size:14px;color:#64748b;background:transparent;transition:all 0.2s ease;}
  .tab.active{background:#3b82f6;color:#ffffff;box-shadow:0 2px 4px rgba(59,130,246,0.3);}
  .hidden{display:none}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:24px;margin-bottom:24px;}
  .zone{border:2px dashed #e2e8f0;border-radius:12px;padding:24px;cursor:pointer;min-height:400px;background:#f1f5f9;transition:all 0.2s ease;position:relative;box-shadow:0 4px 12px rgba(0,0,0,0.08);} 
  .zone:hover,.zone.active{background:#f1f5f9; border-color:#3b82f6; box-shadow:0 4px 12px rgba(0,0,0,0.08); transform:translateY(-1px);} 
  .hint{color:#94a3b8;font-size:12px;margin-top:6px}
  .radios label{margin-right:10px}
  .toolbar{display:flex; gap:8px; margin:8px 0}
  .btn{padding:12px 20px; border:2px solid #3b82f6; border-radius:10px; background:#3b82f6; color:#ffffff; cursor:pointer; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; text-decoration:none; display:inline-block; box-shadow:0 2px 4px rgba(59,130,246,0.3);}
  .btn:hover{background:#2563eb; border-color:#2563eb; transform:translateY(-1px); box-shadow:0 4px 8px rgba(59,130,246,0.4);}
  #runBtn:hover{transform:translateY(-2px); box-shadow:0 15px 35px rgba(102,126,234,0.4);}
  .btn[disabled]{opacity:.55; cursor:not-allowed}
  td[contenteditable="true"]{background:#fffbe6}
  /* 合計不一致行のハイライト（保存時に付与） */
  tr.invalid-row td { background:#e0f2fe !important; }
  tr.selected{outline:2px solid #2ecc71}
  table{border-collapse:collapse; width:100%; max-width:100%;}
  th{background:#f8fafc; border:1px solid #e2e8f0; padding:12px 16px; font-size:14px; font-weight:600; color:#1e293b; text-align:left;}
  td{border:1px solid #e2e8f0; padding:12px 16px; font-size:14px; color:#374151;}
  /* 編集不可のセル（キー列）のスタイル */
  td[data-col="会社キー"], td[data-col="拠点キー"]{
    background:#f8fafc; color:#64748b; cursor:not-allowed;
  }
  /* DB全画面高さ用のラッパ */
  .db-wrap{overflow-x: hidden; overflow-y: auto; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-top:16px; height: 50vh; background:#ffffff;}
  /* ステータス/スピナー */
  .status{margin-left:10px; color:#555}
  .spinner{display:inline-block; width:1em; height:1em; border:2px solid #999; border-top-color:transparent; border-radius:50%; animation:spin .8s linear infinite; vertical-align:-2px; margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .progress{display:inline-block; min-width:80px}

  .filelist{display:flex; flex-direction:column; gap:8px; max-height:240px; overflow-y:auto; margin-bottom:12px; position:relative; z-index:2;}
  .filechip{display:flex; align-items:center; gap:12px; padding:12px 16px; border:1px solid #e2e8f0; border-radius:12px; background:#f1f5f9; transition:all 0.2s cubic-bezier(0.4,0,0.2,1); box-shadow:0 4px 12px rgba(0,0,0,0.08);} 
  .filechip:hover{border-color:#667eea; background:#f8fafc; transform:translateY(-1px); box-shadow:0 4px 6px rgba(0,0,0,0.1);}
  .filechip svg{width:20px; height:20px; flex:0 0 auto; color:#10b981}
  .filechip .name{font-size:14px; color:#1a202c; font-weight:600; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
  .filechip .size{font-size:12px; color:#718096; font-weight:500;}
  .filechip .del{cursor:pointer; border:none; background:#fee2e2; color:#dc2626; font-size:12px; line-height:1; padding:6px 8px; border-radius:8px; transition:all 0.2s ease; font-weight:600;}
  .filechip .del:hover{background:#fecaca; transform:scale(1.05);}
  /* ファイル選択画面用のスタイル */
  .file-selection-chip{display:flex; flex-direction:column; gap:12px; padding:16px; border:1px solid #e2e8f0; border-radius:12px; background:#f1f5f9; transition:all 0.2s cubic-bezier(0.4,0,0.2,1); box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-bottom:16px;}
  .file-selection-chip:hover{border-color:#667eea; background:#f8fafc; transform:translateY(-1px); box-shadow:0 4px 6px rgba(0,0,0,0.1);}
  .file-selection-chip .file-header{display:flex; align-items:center; gap:12px; margin-bottom:12px;}
  .file-selection-chip .file-options{display:flex; flex-direction:column; gap:12px;}
  .file-selection-chip .option-row{display:flex; flex-direction:column; gap:6px;}
  .file-selection-chip .option-label{font-size:14px; font-weight:600; color:#374151;}
  .file-selection-chip .option-controls{display:flex; gap:8px;}
  .file-selection-chip .radio-group{display:flex; gap:8px; flex-wrap:wrap;}
  .file-selection-chip .radio-item{display:flex; align-items:center; gap:6px;}
  .file-selection-chip .radio-item input[type="radio"]{accent-color:#667eea;}
  .file-selection-chip .radio-item label{font-size:14px; font-weight:500; color:#4b5563; cursor:pointer;}
  .file-selection-chip select{width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; background:#ffffff;}
  /* モーダル用スタイル */
  .modal-file-item{margin-bottom:24px; padding:20px; border:1px solid #e2e8f0; border-radius:12px; background:#f1f5f9; box-shadow:0 4px 12px rgba(0,0,0,0.08);} 
  .modal-file-item .file-info{display:flex; align-items:center; gap:12px; margin-bottom:16px;}
  .modal-file-item .file-name{font-size:16px; font-weight:600; color:#1e293b;}
  .modal-file-item .file-size{font-size:14px; color:#64748b;}
  .modal-file-item .question-section{margin-bottom:16px;}
  .modal-file-item .question-label{font-size:14px; font-weight:600; color:#374151; margin-bottom:8px; display:block;}
  .modal-file-item .radio-group{display:flex; gap:12px; flex-wrap:wrap;}
  .modal-file-item .radio-item{display:flex; align-items:center; gap:6px;}
  .modal-file-item .radio-item input[type="radio"]{accent-color:#667eea;}
  .modal-file-item .radio-item label{font-size:14px; font-weight:500; color:#4b5563; cursor:pointer;}
  .modal-file-item select{width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; background:#ffffff;}
  .radio-label:hover{border-color:#667eea; background:#f8fafc; transform:translateY(-1px); box-shadow:0 4px 6px rgba(0,0,0,0.1);}
  .radio-label:has(input:checked){border-color:#667eea; background:linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%); box-shadow:0 4px 6px rgba(102,126,234,0.2);}
  select:hover{border-color:#667eea; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
</style>

<section id="panel-input">
  <div style="width:100%; padding:0 24px; margin-top:0;">
    <div style="background:#ffffff; border-radius:16px; padding:32px; box-shadow:0 4px 6px rgba(0,0,0,0.05); border:1px solid #e2e8f0;">
      <div class="tabs" style="margin-bottom:16px;">
        <div id="tab-input" class="tab active" style="display:flex; align-items:center; gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>作成</div>
        <div id="tab-db" class="tab" style="display:flex; align-items:center; gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></svg>データベース</div>
      </div>
      <div id="input-content">
        <div style="text-align:center; margin-bottom:32px;">
          <div style="display:inline-flex; align-items:center; justify-content:center; width:56px; height:56px; background:#3b82f6; border-radius:12px; margin-bottom:16px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
          </div>
          <h1 style="font-size:28px; font-weight:700; color:#1e293b; margin:0 0 8px 0;">事業計画変更届出書作成システム</h1>
          <p style="color:#64748b; margin:0; font-size:16px;">連絡書をアップロードして、事業計画変更届出書を簡単に作成できます</p>
        </div>
        <form id="makeForm" enctype="multipart/form-data" onsubmit="return false;">
    <div class="grid">
      <div class="zone" id="incZone" tabindex="0">
        <div style="text-align:center; margin-bottom:16px;">
          <div style="display:inline-flex; align-items:center; justify-content:center; width:48px; height:48px; background:#10b981; border-radius:12px; margin-bottom:12px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17,8 12,3 7,8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
          </div>
          <h3 style="font-size:18px; font-weight:600; color:#1e293b; margin:0 0 4px 0;">① 連絡書（増車）</h3>
          <p style="color:#64748b; font-size:14px; margin:0;">ここをクリック / ファイルをドロップ</p>
        </div>
        <input id="incInput" type="file" name="increase_files" multiple accept=".xlsx" hidden>
        <label for="incInput" style="display:block; position:absolute; top:0; left:0; right:0; bottom:0; cursor:pointer; z-index:1; pointer-events:auto;"></label>
        <div style="margin-top:16px;">
          <div id="incList" class="filelist" aria-live="polite" style="margin-bottom:12px;"></div>
          <div style="font-size:12px; color:#718096; text-align:center;">同一会社・同一拠点のファイルのみ一括アップロード可 <span id="incCount" style="font-weight:600; color:#667eea;"></span></div>
        </div>
      </div>
      <div class="zone" id="decZone" tabindex="0">
        <div style="text-align:center; margin-bottom:16px;">
          <div style="display:inline-flex; align-items:center; justify-content:center; width:48px; height:48px; background:#10b981; border-radius:12px; margin-bottom:12px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7,10 12,15 17,10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </div>
          <h3 style="font-size:18px; font-weight:600; color:#1e293b; margin:0 0 4px 0;">② 連絡書（減車）</h3>
          <p style="color:#64748b; font-size:14px; margin:0;">ここをクリック / ファイルをドロップ</p>
        </div>
        <input id="decInput" type="file" name="decrease_files" multiple accept=".xlsx" hidden>
        <label for="decInput" style="display:block; position:absolute; top:0; left:0; right:0; bottom:0; cursor:pointer; z-index:1; pointer-events:auto;"></label>
        <div style="margin-top:16px;">
          <div id="decList" class="filelist" aria-live="polite" style="margin-bottom:12px;"></div>
          <div style="font-size:12px; color:#718096; text-align:center;">同一会社・同一拠点のファイルのみ一括アップロード可 <span id="decCount" style="font-weight:600; color:#667eea;"></span></div>
        </div>
      </div>
    </div>

    <div style="margin-top:32px; text-align:center;">
      <button id="answerQuestionsBtn" style="background:#2563eb; color:white; border:none; padding:16px 32px; font-size:16px; font-weight:600; border-radius:12px; cursor:pointer; transition:all 0.2s ease; box-shadow:0 4px 12px rgba(37,99,235,0.3); margin-right:16px;">
        <span style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          質問に答える
        </span>
      </button>
      <button id="runBtn" disabled style="background:#94a3b8; color:white; border:none; padding:16px 32px; font-size:16px; font-weight:600; border-radius:12px; cursor:not-allowed; transition:all 0.2s ease; box-shadow:0 4px 12px rgba(148,163,184,0.3);">
        <span style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7,10 12,15 17,10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          作成してダウンロード
        </span>
      </button>
        <div id="upStatus" style="margin-top:16px; font-weight:500; color:#64748b; font-size:14px;"></div>
      </div>
      </form>
      </div>

      <div id="db-content" class="hidden">
        <div class="toolbar" style="position:sticky; top:0; background:#ffffff; z-index:10; padding:16px 0; margin-bottom:20px; border-bottom:1px solid #e2e8f0; display:flex; gap:12px; flex-wrap:wrap;">
          <button id="db-edit" style="padding:12px 20px; border:2px solid #3b82f6; border-radius:10px; background:#3b82f6; color:#ffffff; cursor:pointer; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(59,130,246,0.3); display:flex; align-items:center; gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>編集開始</button>
          <button id="db-save" disabled style="padding:12px 20px; border:2px solid #94a3b8; border-radius:10px; background:#94a3b8; color:#ffffff; cursor:not-allowed; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(148,163,184,0.3); opacity:0.6; display:flex; align-items:center; gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>保存</button>
          <button id="db-add-above" disabled style="padding:12px 20px; border:2px solid #94a3b8; border-radius:10px; background:#94a3b8; color:#ffffff; cursor:not-allowed; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(148,163,184,0.3); opacity:0.6; display:flex; align-items:center; gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>選択行の上に行を追加</button>
          <button id="db-add" disabled style="padding:12px 20px; border:2px solid #94a3b8; border-radius:10px; background:#94a3b8; color:#ffffff; cursor:not-allowed; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(148,163,184,0.3); opacity:0.6; display:flex; align-items:center; gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>一番下に行を追加</button>
            <button id="db-del" disabled style="padding:12px 20px; border:2px solid #94a3b8; border-radius:10px; background:#94a3b8; color:#ffffff; cursor:not-allowed; margin-right:12px; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(148,163,184,0.3); opacity:0.6; display:flex; align-items:center; gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>選択行を削除</button>
          <a id="db-download" style="padding:12px 20px; border:2px solid #f59e0b; border-radius:10px; background:#f59e0b; color:#ffffff; cursor:pointer; font-size:14px; font-weight:600; transition:all 0.2s ease; box-shadow:0 2px 4px rgba(245,158,11,0.3); text-decoration:none; display:inline-flex; align-items:center; gap:8px;" href="/db/csv"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>CSV</a>
          <span id="db-msg" style="margin-left:12px; color:#64748b; font-weight:500;"></span>
        </div>
        <div id="mode-indicator" style="text-align:center; margin-bottom:16px; font-size:20px; font-weight:700; color:#3b82f6; padding:12px; background:#f8fafc; border-radius:8px; border:2px solid #e2e8f0;">
          閲覧モード
        </div>
        <div id="dbWrap" class="db-wrap" style="height:calc(100vh - 300px); overflow-y:auto;">
          <table id="db-table"></table>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 質問モーダル -->
<div id="questionModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); overflow-y:auto;">
  <div class="modal-content" style="background-color:#ffffff; margin:2% auto; padding:32px; border-radius:16px; width:90%; max-width:700px; max-height:90vh; box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow-y:auto;">
    <div style="text-align:center; margin-bottom:32px;">
      <h2 style="font-size:24px; font-weight:700; color:#1e293b; margin:0 0 8px 0;">ファイルの詳細を入力してください</h2>
      <p style="color:#64748b; margin:0; font-size:16px;">アップロードされたファイルの種別と積載トン数を選択してください</p>
    </div>
    
    <div id="modalFileList" style="margin-bottom:32px;">
      <!-- ファイルリストがここに動的に生成される -->
    </div>
    
    <div style="text-align:center;">
      <button id="modalConfirmBtn" style="background:#3b82f6; color:white; border:none; padding:12px 24px; font-size:14px; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s ease; margin-right:12px;">
        確定
      </button>
      <button id="modalCancelBtn" style="background:#6b7280; color:white; border:none; padding:12px 24px; font-size:14px; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s ease;">
        キャンセル
      </button>
    </div>
  </div>
</div>

<script>

// 実行成功後にアップロード選択を初期化（成功時のみ）
function _clearFileInput(input){
  try{ input.value = ""; }
  catch(e){ const dt = new DataTransfer(); input.files = dt.files; }
}
function resetUploadsAfterSuccess(){
  if (window._incStore) _incStore.length = 0;
  if (window._decStore) _decStore.length = 0;
  const incInput = document.getElementById('incInput');
  const decInput = document.getElementById('decInput');
  const incList  = document.getElementById('incList');
  const decList  = document.getElementById('decList');
  const incCount = document.getElementById('incCount');
  const decCount = document.getElementById('decCount');
  if (incInput) _clearFileInput(incInput);
  if (decInput) _clearFileInput(decInput);
  if (typeof _syncAll === 'function'){
    _syncAll(incInput, _incStore, incList, incCount);
    _syncAll(decInput, _decStore, decList, decCount);
  }
}


// --- header/record key resolver (handles spaces/dots/full-width) ---
function _normHeader(s){
  return String(s||'').replace(/[\u3000\s\.]/g,'').replace(/・/g,'');
}
function _buildKeyResolver(headers, records){
  const allKeys = new Set();
  (records||[]).forEach(r=>{ if(r) Object.keys(r).forEach(k=>allKeys.add(k)); });
  const keys = Array.from(allKeys);
  const res = {};
  headers.forEach(h=>{
    let use = h;
    if(!(records?.[0]||{})[h]){
      const nh = _normHeader(h);
      for(const k of keys){
        if(_normHeader(k) === nh){ use = k; break; }
      }
    }
    res[h] = use;
  });
  return res;
}


// ======== Multiple file stores & UI sync (non-breaking) ========
const _incStore = [];
const _decStore = [];
// ファイルオブジェクトをキーにした回答情報のマップ
const _fileAnswersMap = new Map();

function _filesEqual(a,b){ return a.name===b.name && a.size===b.size && a.lastModified===b.lastModified; }

function _mergeFiles(store, files){
  const arr = Array.from(files||[]);
  const duplicates = [];
  arr.forEach(f=>{
    // name、size、lastModifiedすべてで判定
    if(store.some(x=>f.name === x.name && f.size === x.size && f.lastModified === x.lastModified)){
      duplicates.push(f.name);
    }
  });
  
  // 重複がある場合はエラーを表示
  if(duplicates.length > 0){
    alert(`同じファイルがアップロードされています:\n${duplicates.join('\n')}`);
    return; // マージしない
  }
  
  // 重複がなければ追加
  arr.forEach(f=>{
    if(!store.some(x=>_filesEqual(x,f))) store.push(f);
  });
}

function _setInputFromStore(input, store){
  const dt = new DataTransfer();
  store.forEach(f=>dt.items.add(f));
  input.files = dt.files;
}

function renderFileListFromStore(listEl, store){
  console.log('renderFileListFromStore呼び出し:', {
    listEl: listEl ? listEl.id : 'null',
    storeLength: store.length
  });
  if(!listEl) {
    console.log('listElがnullです');
    return;
  }
  listEl.innerHTML = '';
  store.forEach((f,idx)=>{
    console.log('ファイル追加:', f.name, 'インデックス:', idx);
    const div = document.createElement('div');
    div.className = 'filechip';
    const size = formatFileSize(f.size);
    div.innerHTML = `<button class="del" data-idx="${idx}" aria-label="削除" style="font-size:20px; padding:4px 8px; margin-right:8px;">×</button>` + `<span class="name" title="${f.name}">${f.name}</span>` + `<span class="size">${size}</span>`;
    listEl.appendChild(div);
  });
  console.log('ファイルリスト更新完了:', listEl.children.length, '件');
  
  // ファイルがアップロードされたら質問回答状況をリセット
  _questionAnswered = false;
  
  // ボタンの状態を更新
  updateRunButtonState();
  updateAnswerQuestionsButtonState();
}

function _syncAll(input, store, listEl, countEl){
  console.log('_syncAll呼び出し:', {
    storeLength: store.length,
    listEl: listEl ? listEl.id : 'null',
    countEl: countEl ? countEl.id : 'null'
  });
  // input.filesは更新しない（重複を避けるため）
  fileCountBadge(input, countEl, store);
  renderFileListFromStore(listEl, store);
}

// 質問に答えるボタンの処理
document.addEventListener('DOMContentLoaded', ()=>{
  const answerQuestionsBtn = document.getElementById('answerQuestionsBtn');
  const questionModal = document.getElementById('questionModal');
  const modalCancelBtn = document.getElementById('modalCancelBtn');
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');
  
  // 初期状態でボタンを無効化
  updateRunButtonState();
  updateAnswerQuestionsButtonState();
  
  if(answerQuestionsBtn){
    answerQuestionsBtn.addEventListener('click', ()=>{
      // ストアからファイルを取得
      const incFiles = Array.from(_incStore);
      const decFiles = Array.from(_decStore);
      
      if(incFiles.length === 0 && decFiles.length === 0){
        alert('ファイルをアップロードしてください。');
        return;
      }
      
      // モーダルにファイルリストを生成
      generateModalFileList(incFiles, decFiles);
      
      // モーダルを表示
      questionModal.style.display = 'block';
    });
  }
  
  // モーダルキャンセル
  if(modalCancelBtn){
    modalCancelBtn.addEventListener('click', ()=>{
      questionModal.style.display = 'none';
    });
  }
  
  // モーダル確定
  if(modalConfirmBtn){
    modalConfirmBtn.addEventListener('click', ()=>{
      // 回答を収集してファイルリストに反映
      collectAnswersAndUpdateDisplay();
      questionModal.style.display = 'none';
    });
  }
  
  // モーダル外クリックでは閉じない（確定ボタンのみで閉じる）
});

// モーダル用ファイルリストを生成
function generateModalFileList(incFiles, decFiles){
  const modalFileList = document.getElementById('modalFileList');
  modalFileList.innerHTML = '';
  
  let fileIndex = 0;
  
  // 増車ファイル
  incFiles.forEach((file, idx) => {
    const fileDiv = createModalFileItem(file, fileIndex, 'increase');
    modalFileList.appendChild(fileDiv);
    fileIndex++;
  });
  
  // 減車ファイル
  decFiles.forEach((file, idx) => {
    const fileDiv = createModalFileItem(file, fileIndex, 'decrease');
    modalFileList.appendChild(fileDiv);
    fileIndex++;
  });
}

// モーダル用ファイルアイテムを作成
function createModalFileItem(file, index, type){
  const div = document.createElement('div');
  div.className = 'modal-file-item';
  
  const size = formatFileSize(file.size);
  const typeLabel = type === 'increase' ? '増車' : '減車';
  // 減車の場合は削除ボタンと同じ色（背景:#fee2e2、テキスト:#dc2626）を適用
  const badgeStyle = type === 'decrease' 
    ? 'background:#fee2e2; color:#dc2626; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600;'
    : 'background:#3b82f6; color:white; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600;';
  
  div.innerHTML = `
    <div class="file-info">
      <span class="file-name">${file.name}</span>
      <span class="file-size">${size}</span>
      <span style="${badgeStyle}">${typeLabel}</span>
    </div>
    
    <div class="question-section">
      <label class="question-label">① 種別</label>
      <div class="radio-group">
        <div class="radio-item">
          <input type="radio" name="car_type_${index}" value="普通" checked>
          <label>普通</label>
        </div>
        <div class="radio-item">
          <input type="radio" name="car_type_${index}" value="小型">
          <label>小型</label>
        </div>
        <div class="radio-item">
          <input type="radio" name="car_type_${index}" value="けん引">
          <label>けん引</label>
        </div>
        <div class="radio-item">
          <input type="radio" name="car_type_${index}" value="被けん引">
          <label>被けん引</label>
        </div>
      </div>
    </div>
    
    <div class="question-section">
      <label class="question-label">② 積載トン数</label>
      <select name="weight_class_${index}">
        <option value="to_2t">2.0トンまで</option>
        <option value="2t_long">2.0トンロング</option>
        <option value="over_2t_long_to_7_5t">2.0トンロング超～7.5トンまで</option>
        <option value="over_7_5t">7.5トンを超えるもの</option>
      </select>
    </div>
  `;
  
  return div;
}

// 回答を収集してファイルリストに反映
function collectAnswersAndUpdateDisplay(){
  // ストアからファイルを取得
  const incFiles = Array.from(_incStore);
  const decFiles = Array.from(_decStore);
  const allFiles = [...incFiles, ...decFiles];
  
  // 各ファイルの回答を収集
  const fileAnswers = [];
  allFiles.forEach((file, index) => {
    const carTypeRadio = document.querySelector(`input[name="car_type_${index}"]:checked`);
    const weightSelect = document.querySelector(`select[name="weight_class_${index}"]`);
    
    // ファイルの種類は元のアップロード時の分類を使用
    const fileType = incFiles.includes(file) ? 'increase' : 'decrease';
    
    const answer = {
      file: file,
      fileType: fileType,
      carType: carTypeRadio ? carTypeRadio.value : '普通',
      weightClass: weightSelect ? weightSelect.value : 'to_2t'
    };
    
    // ファイルオブジェクトをキーに回答をマップに保存
    _fileAnswersMap.set(file, answer);
    
    fileAnswers.push(answer);
  });
  
  // ファイルリストを更新（アイコン表示）
  updateFileListWithAnswers(fileAnswers);
}

// ファイルリストを回答付きで更新
function updateFileListWithAnswers(fileAnswers){
  const incList = document.getElementById('incList');
  const decList = document.getElementById('decList');
  
  // 既存のリストをクリア
  incList.innerHTML = '';
  decList.innerHTML = '';
  
  fileAnswers.forEach((answer, index) => {
    const div = document.createElement('div');
    div.className = 'filechip';
    const size = formatFileSize(answer.file.size);
    
    // ストア内の実際のインデックスを取得
    let actualIndex;
    if(answer.fileType === 'increase'){
      actualIndex = _incStore.indexOf(answer.file);
    } else {
      actualIndex = _decStore.indexOf(answer.file);
    }
    
    // アイコンと情報を表示
    const typeIcon = answer.fileType === 'increase' ? '📈' : '📉';
    const typeLabel = answer.fileType === 'increase' ? '増車' : '減車';
    
    div.innerHTML = `
      <button class="del" data-idx="${actualIndex}" aria-label="削除" style="font-size:20px; padding:4px 8px; margin-right:8px;">×</button>
      <span class="name" title="${answer.file.name}">${answer.file.name}</span>
      <span class="size">${size}</span>
      <span style="background:#f59e0b; color:white; padding:3px 8px; border-radius:4px; font-size:16px; font-weight:600; margin-left:8px;">${typeLabel}</span>
      <span style="background:#f59e0b; color:white; padding:3px 8px; border-radius:4px; font-size:16px; font-weight:600; margin-left:4px;">${answer.carType}</span>
      <span style="background:#f59e0b; color:white; padding:3px 8px; border-radius:4px; font-size:16px; font-weight:600; margin-left:4px;">${getWeightLabel(answer.weightClass)}</span>
    `;
    
    if(answer.fileType === 'increase'){
      incList.appendChild(div);
    } else {
      decList.appendChild(div);
    }
  });
  
  // 削除ボタンのイベントリスナーを追加
  addDeleteListeners();
  
  // 質問に答えたことを記録
  _questionAnswered = true;
  
  // ボタンの状態を更新
  updateRunButtonState();
  updateAnswerQuestionsButtonState();
}

// ファイルの質問回答状況を追跡する変数
let _questionAnswered = false;

// ボタンの状態を更新する関数
function updateRunButtonState(){
  const runBtn = document.getElementById('runBtn');
  const incFiles = Array.from(_incStore);
  const decFiles = Array.from(_decStore);
  const allFiles = [...incFiles, ...decFiles];
  
  if(allFiles.length === 0 || !_questionAnswered){
    // ファイルがない場合、または質問に答えていない場合は無効化
    runBtn.disabled = true;
    runBtn.style.background = '#94a3b8';
    runBtn.style.cursor = 'not-allowed';
    runBtn.style.boxShadow = '0 4px 12px rgba(148,163,184,0.3)';
  } else {
    // ファイルがあり、質問に答えた場合は有効化
    runBtn.disabled = false;
    runBtn.style.background = '#1d4ed8';
    runBtn.style.cursor = 'pointer';
    runBtn.style.boxShadow = '0 4px 12px rgba(29,78,216,0.3)';
  }
}

// 会社キー/拠点キー用：空白（半角/全角）を除去して比較用に正規化
function normalizeKey(s){
  return (s || '').replace(/[\s\u3000]+/g, '');
}

function updateAnswerQuestionsButtonState(){
  const answerQuestionsBtn = document.getElementById('answerQuestionsBtn');
  const incFiles = Array.from(_incStore);
  const decFiles = Array.from(_decStore);
  const allFiles = [...incFiles, ...decFiles];
  
  if(allFiles.length === 0){
    // ファイルがない場合は無効化
    answerQuestionsBtn.disabled = true;
    answerQuestionsBtn.style.background = '#94a3b8';
    answerQuestionsBtn.style.cursor = 'not-allowed';
    answerQuestionsBtn.style.opacity = '0.6';
    answerQuestionsBtn.style.boxShadow = '0 4px 12px rgba(148,163,184,0.3)';
  } else {
    // ファイルがある場合は有効化
    answerQuestionsBtn.disabled = false;
    answerQuestionsBtn.style.background = '#2563eb';
    answerQuestionsBtn.style.cursor = 'pointer';
    answerQuestionsBtn.style.opacity = '1';
    answerQuestionsBtn.style.boxShadow = '0 4px 12px rgba(37,99,235,0.3)';
  }
}

// 削除ボタンのイベントリスナーを追加
function addDeleteListeners(){
  const incList = document.getElementById('incList');
  const decList = document.getElementById('decList');
  
  // 増車ファイルの削除
  if(incList){
    incList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const fileIndex = +btn.dataset.idx;
      if(Number.isInteger(fileIndex)){
                // 削除対象のファイルを取得
                const deletedFile = _incStore[fileIndex];
                
                // ストアからファイルを削除
                _incStore.splice(fileIndex, 1);
                
                // マップからも回答情報を削除
                if(deletedFile){
                  _fileAnswersMap.delete(deletedFile);
                }
                
                // ファイルリストを再生成
                const incFiles = Array.from(_incStore);
                const decFiles = Array.from(_decStore);
                const allFiles = [...incFiles, ...decFiles];
                
                if(allFiles.length === 0){
                  // ファイルがない場合は空のリストを表示
                  incList.innerHTML = '';
                  decList.innerHTML = '';
                  // カウントを更新
                  const incCount = document.getElementById('incCount');
                  const decCount = document.getElementById('decCount');
                  if(incCount) incCount.textContent = '';
                  if(decCount) decCount.textContent = '';
                } else {
                  // ファイルがある場合は回答付きで再表示（マップから回答情報を取得）
                  const fileAnswers = [];
                  allFiles.forEach((file) => {
                    // マップから回答情報を取得、なければデフォルト値を使用
                    const savedAnswer = _fileAnswersMap.get(file);
                    const fileType = incFiles.includes(file) ? 'increase' : 'decrease';
                    
                    fileAnswers.push({
                      file: file,
                      fileType: fileType,
                      carType: savedAnswer ? savedAnswer.carType : '普通',
                      weightClass: savedAnswer ? savedAnswer.weightClass : 'to_2t'
                    });
                  });
                  updateFileListWithAnswers(fileAnswers);
                }
                
                // ファイルが削除されたら質問回答状況をリセット
                _questionAnswered = false;
                
                // ボタンの状態を更新
                updateRunButtonState();
                updateAnswerQuestionsButtonState();
      }
    });
  }
  
  // 減車ファイルの削除
  if(decList){
    decList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const fileIndex = +btn.dataset.idx;
      if(Number.isInteger(fileIndex)){
                // 削除対象のファイルを取得
                const deletedFile = _decStore[fileIndex];
                
                // ストアからファイルを削除
                _decStore.splice(fileIndex, 1);
                
                // マップからも回答情報を削除
                if(deletedFile){
                  _fileAnswersMap.delete(deletedFile);
                }
                // ファイルリストを再生成
                const incFiles = Array.from(_incStore);
                const decFiles = Array.from(_decStore);
                const allFiles = [...incFiles, ...decFiles];
                
                if(allFiles.length === 0){
                  // ファイルがない場合は空のリストを表示
                  incList.innerHTML = '';
                  decList.innerHTML = '';
                  // カウントを更新
                  const incCount = document.getElementById('incCount');
                  const decCount = document.getElementById('decCount');
                  if(incCount) incCount.textContent = '';
                  if(decCount) decCount.textContent = '';
                } else {
                  // ファイルがある場合は回答付きで再表示（マップから回答情報を取得）
                  const fileAnswers = [];
                  allFiles.forEach((file) => {
                    // マップから回答情報を取得、なければデフォルト値を使用
                    const savedAnswer = _fileAnswersMap.get(file);
                    const fileType = incFiles.includes(file) ? 'increase' : 'decrease';
                    
                    fileAnswers.push({
                      file: file,
                      fileType: fileType,
                      carType: savedAnswer ? savedAnswer.carType : '普通',
                      weightClass: savedAnswer ? savedAnswer.weightClass : 'to_2t'
                    });
                  });
                  updateFileListWithAnswers(fileAnswers);
                }
                
                // ファイルが削除されたら質問回答状況をリセット
                _questionAnswered = false;
                
                // ボタンの状態を更新
                updateRunButtonState();
                updateAnswerQuestionsButtonState();
      }
    });
  }
}

// 重量クラスのラベルを取得
function getWeightLabel(weightClass){
  const labels = {
    'to_2t': '2.0t',
    '2t_long': '2.0tL',
    'over_2t_long_to_7_5t': '2.0tL+',
    'over_7_5t': '7.5t+'
  };
  return labels[weightClass] || weightClass;
}

// ===============================================================

document.addEventListener('DOMContentLoaded', ()=>{
  const incInput = document.getElementById('increase_files') || document.getElementById('incInput');
  const decInput = document.getElementById('decrease_files') || document.getElementById('decInput');
  const incList  = document.getElementById('incList');
  const decList  = document.getElementById('decList');
  const incCount = document.getElementById('incCount');
  const decCount = document.getElementById('decCount');

  console.log('DOM要素取得状況:', {
    incInput: incInput ? incInput.id : 'null',
    decInput: decInput ? decInput.id : 'null',
    incList: incList ? incList.id : 'null',
    decList: decList ? decList.id : 'null',
    incCount: incCount ? incCount.id : 'null',
    decCount: decCount ? decCount.id : 'null'
  });

  // 追加ボタンは削除されたため、枠内タップのみでファイル選択

  // 既存 change を拡張：新規選択を store にマージ
  if(incInput){
    incInput.addEventListener('change', (e)=>{
      console.log('増車ファイル選択:', e.target.files.length, '件');
      if(e.target.files && e.target.files.length > 0){
        const beforeCount = _incStore.length;
        _mergeFiles(_incStore, e.target.files);
        const afterCount = _incStore.length;
        console.log('増車ストア:', beforeCount, '→', afterCount, '件');
        _syncAll(incInput, _incStore, incList, incCount);
        // inputをクリアして次回の選択を可能にする
        e.target.value = '';
      }
    });
  }
  if(decInput){
    decInput.addEventListener('change', (e)=>{
      console.log('減車ファイル選択:', e.target.files.length, '件');
      if(e.target.files && e.target.files.length > 0){
        const beforeCount = _decStore.length;
        _mergeFiles(_decStore, e.target.files);
        const afterCount = _decStore.length;
        console.log('減車ストア:', beforeCount, '→', afterCount, '件');
        _syncAll(decInput, _decStore, decList, decCount);
        // inputをクリアして次回の選択を可能にする
        e.target.value = '';
      }
    });
  }

  // チップの×で削除（イベント委譲）
  if(incList){
    incList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const idx = +btn.dataset.idx;
      if(Number.isInteger(idx)){
        _incStore.splice(idx,1);
        _syncAll(incInput, _incStore, incList, incCount);
      }
    });
  }
  if(decList){
    decList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const idx = +btn.dataset.idx;
      if(Number.isInteger(idx)){
        _decStore.splice(idx,1);
        _syncAll(decInput, _decStore, decList, decCount);
      }
    });
  }

  // すでにある wireDrop() は input に files をセットして change を発火するので、
  // ここでの change ハンドラが store にマージし、UIと件数を更新します（互換維持）。
  
  // ドラッグ&ドロップ処理を設定
  wireDrop('incZone', 'incInput', _incStore, incList, incCount);
  wireDrop('decZone', 'decInput', _decStore, decList, decCount);
});

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function renderFileList(inputEl, listEl){
  if(!listEl) return;
  listEl.innerHTML = '';
  const files = Array.from(inputEl.files || []);
  if(files.length === 0){ return; }
  const icon = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2h7l5 5v15a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" fill="#059669"/><path d="M14 2v5h5" fill="#10b981"/></svg>`;
  files.forEach(f=>{
    const div = document.createElement('div');
    div.className = 'filechip';
    const size = formatFileSize(f.size);
    div.innerHTML = `<span class="name" title="${f.name}">${f.name}</span>` + `<span class="size">${size}</span>` + icon;
    listEl.appendChild(div);
  });
}

function wireDrop(zoneId, inputId, store, listEl, countEl){
  const zone = document.getElementById(zoneId);
  const input = document.getElementById(inputId);
  // zone.addEventListener('click', ()=> input.click()); // <label>との二重トリガを避けるため削除
  zone.addEventListener('focus', ()=> zone.classList.add('active'));
  zone.addEventListener('blur',  ()=> zone.classList.remove('active'));
  ['dragenter','dragover'].forEach(ev=>zone.addEventListener(ev, e=>{e.preventDefault(); zone.classList.add('active');}));
  ['dragleave','drop'].forEach(ev=>zone.addEventListener(ev, e=>{e.preventDefault(); zone.classList.remove('active');}));
  zone.addEventListener('drop', e=>{ 
    console.log('ドラッグ&ドロップ:', e.dataTransfer.files.length, '件');
    const beforeCount = store.length;
    _mergeFiles(store, e.dataTransfer.files);
    const afterCount = store.length;
    console.log('ストア更新:', beforeCount, '→', afterCount, '件');
    _syncAll(input, store, listEl, countEl);
  });
}
function fileCountBadge(input, badgeEl, store){
  const n = store?.length || 0;
  badgeEl.textContent = n ? `（${n}件選択）` : '';
}
// wireDropの呼び出しは、DOMContentLoaded内で行う

const tabInput = document.getElementById('tab-input');
const tabDb = document.getElementById('tab-db');
const inputContent = document.getElementById('input-content');
const dbContent = document.getElementById('db-content');

tabInput.addEventListener('click', ()=>{
  tabInput.classList.add('active'); tabDb.classList.remove('active');
  inputContent.style.display = 'block'; dbContent.style.display = 'none';
});

tabDb.addEventListener('click', async ()=>{
  tabDb.classList.add('active'); tabInput.classList.remove('active');
  dbContent.style.display = 'block'; inputContent.style.display = 'none';
  resizeDB(); await loadDB();
});

function resizeDB(){
  const wrap = document.getElementById('dbWrap');
  const top = wrap.getBoundingClientRect().top + window.scrollY;
  const paddingBottom = 24;
  const h = Math.max(300, window.innerHeight - (top - window.scrollY) - paddingBottom);
  wrap.style.height = h + 'px';
}
window.addEventListener('resize', resizeDB);

let DB = {headers:[], records:[]};
let editable = false;
let selectedRow = null;
let dbIsDirty = false; // データベースの変更状態を追跡

// 編集セル移動用ユーティリティ（Excel風操作）
function focusCellAtEnd(td){
  if(!td) return;
  td.focus();
  const sel = window.getSelection();
  if(!sel) return;
  const range = document.createRange();
  range.selectNodeContents(td);
  range.collapse(false);
  sel.removeAllRanges();
  sel.addRange(range);
}
function moveToCellBelow(currentTd){
  if(!currentTd) return;
  const tr = currentTd.closest('tr');
  const col = currentTd.getAttribute('data-col');
  if(!tr || !col) return;
  const nextTr = tr.nextElementSibling;
  if(!nextTr) return;
  const nextTd = nextTr.querySelector(`td[data-col="${col}"]`);
  if(nextTd){
    // 緑の枠を更新
    if(selectedRow) selectedRow.classList.remove('selected');
    selectedRow = nextTr;
    selectedRow.classList.add('selected');
    focusCellAtEnd(nextTd);
  }
}
function moveToCellAbove(currentTd){
  if(!currentTd) return;
  const tr = currentTd.closest('tr');
  const col = currentTd.getAttribute('data-col');
  if(!tr || !col) return;
  const prevTr = tr.previousElementSibling;
  if(!prevTr) return;
  const prevTd = prevTr.querySelector(`td[data-col="${col}"]`);
  if(prevTd){
    // 緑の枠を更新
    if(selectedRow) selectedRow.classList.remove('selected');
    selectedRow = prevTr;
    selectedRow.classList.add('selected');
    focusCellAtEnd(prevTd);
  }
}
function insertLineBreakInCell(td){
  // キャレット位置に<br>を挿入して、その直後にキャレットを移動
  const sel = window.getSelection();
  if(!sel || sel.rangeCount === 0) return;
  const range = sel.getRangeAt(0);
  // 操作対象が当該セル内であることを保証
  if(!td.contains(range.startContainer)){
    focusCellAtEnd(td);
  }
  const br = document.createElement('br');
  range.deleteContents();
  range.insertNode(br);
  // <br>の後ろにキャレットを移す
  range.setStartAfter(br);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);
}

async function loadDB(){
  document.getElementById('db-msg').textContent = '読み込み中…';
  try{
    const res = await fetch('/db', {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const flat = await res.json();
    DB = {headers: flat.headers || [], records: flat.records || []};
    renderTable();
    document.getElementById('db-msg').textContent = '';
  }catch(e){
    document.getElementById('db-msg').textContent = '取得失敗: ' + e.message;
  }
}

function renderTable(){
  const tbl = document.getElementById('db-table');
  // 表示用ヘッダ（会社キー・拠点キーは非表示）
  const displayHeaders = DB.headers.filter(h => h !== '会社キー' && h !== '拠点キー');
  const thead = `<thead><tr>${[''].concat(displayHeaders).map((h,i)=> i===0 ? `<th style="width:56px; text-align:right; color:#64748b;"> </th>` : `<th>${h}</th>`).join('')}</tr></thead>`;
  const keyMap = _buildKeyResolver(DB.headers, DB.records);
  
  // キー列を自動更新
  DB.records.forEach((record, idx) => {
    if (record && typeof record === 'object') {
      // 会社キーを会社名から設定
      record['会社キー'] = record['会社名'] || '';
      
      // 拠点キーを営業所所在地と本社/営業所/支店から設定
      const location = record['営業所所在地'] || '';
      const type = record['本社/営業所/支店'] || '';
      
      if (location.trim() === '') {
        record['拠点キー'] = `|${type}`;
      } else {
        record['拠点キー'] = `${location}|${type}`;
      }
    }
  });
  
  const tbody = `<tbody>${
    DB.records.map((r, idx)=>{
      // 表示用にキー列を除いた値配列を生成
      const rowObj = Array.isArray(r) ? Object.fromEntries(DB.headers.map((h,i)=>[DB.headers[i], r[i]])) : r || {};
      return `<tr data-idx="${idx}">` + [`<td data-col="_rownum" style="text-align:right; color:#64748b; font-weight:600;">${idx+1}</td>`].concat(displayHeaders.map((h)=>{
        const c = rowObj?.[keyMap[h]] ?? rowObj?.[h] ?? '';
        const ce = editable ? 'contenteditable="true"' : '';
        // 会社名は太字で表示
        const boldStyle = h === '会社名' ? ' style="font-weight:700;"' : '';
        return `<td ${ce} data-col="${h}"${boldStyle}>${c ?? ''}</td>`;
      })).join('') + `</tr>`;
    }).join('')
  }</tbody>`;
  tbl.innerHTML = thead + tbody;
  tbl.querySelectorAll('tbody tr').forEach(tr=>{
    tr.addEventListener('click', ()=>{
      if(selectedRow) selectedRow.classList.remove('selected');
      selectedRow = tr; tr.classList.add('selected');
    });
    
    // セル編集時のキー列自動更新
    tr.querySelectorAll('td[contenteditable="true"]').forEach(td => {
      // Enterで下セル、Alt+Enterで改行、Shift+Enterで上セル
      td.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          if(e.altKey){
            // Alt+Enter: 明示的にセル内改行
            e.preventDefault();
            insertLineBreakInCell(td);
            return;
          }
          if(e.shiftKey){
            // 上セルへ移動
            e.preventDefault();
            moveToCellAbove(td);
            return;
          }
          // 下セルへ移動
          e.preventDefault();
          moveToCellBelow(td);
        }
      });
      td.addEventListener('blur', () => {
        const col = td.getAttribute('data-col');
        const rowIdx = parseInt(tr.getAttribute('data-idx'));
        const newValue = td.textContent.trim();
        
        // 会社名、営業所所在地、本社/営業所/支店が変更された場合
        if (col === '会社名' || col === '営業所所在地' || col === '本社/営業所/支店') {
          const record = DB.records[rowIdx];
          if (record && typeof record === 'object') {
            record[col] = newValue;
            
            // 会社キーを更新
            if (col === '会社名') {
              record['会社キー'] = newValue;
            }
            
            // 拠点キーを更新
            const location = record['営業所所在地'] || '';
            const type = record['本社/営業所/支店'] || '';
            
            if (location.trim() === '') {
              record['拠点キー'] = `|${type}`;
            } else {
              record['拠点キー'] = `${location}|${type}`;
            }
            
            // キー列の表示を更新（現在は非表示のため存在チェック）
            const keyTd = tr.querySelector('td[data-col="会社キー"]');
            const officeKeyTd = tr.querySelector('td[data-col="拠点キー"]');
            if(keyTd) keyTd.textContent = record['会社キー'] || '';
            if(officeKeyTd) officeKeyTd.textContent = record['拠点キー'] || '';
            
            // 重複チェック（会社キーと拠点キーが両方入力されている場合のみ）
            const companyKey = record['会社キー'] || '';
            const officeKey = record['拠点キー'] || '';
            
            if(companyKey && officeKey){
              // 同じ会社キーと拠点キーの組み合わせが、他の行に存在するかチェック
              const isDuplicate = DB.records.some((otherRecord, otherIdx) => {
                // 現在の行は除外
                if(otherIdx === rowIdx) return false;
                const otherCompanyKey = normalizeKey(otherRecord['会社キー'] || '');
                const otherOfficeKey = normalizeKey(otherRecord['拠点キー'] || '');
                return otherCompanyKey === normalizeKey(companyKey) && otherOfficeKey === normalizeKey(officeKey);
              });
              
              if(isDuplicate){
                alert('既に登録されています。');
                // 変更を元に戻す
                if (col === '会社名') {
                  record['会社キー'] = '';
                }
                const location = record['営業所所在地'] || '';
                const type = record['本社/営業所/支店'] || '';
                if (location.trim() === '') {
                  record['拠点キー'] = `|${type}`;
                } else {
                  record['拠点キー'] = `${location}|${type}`;
                }
                // 表示を更新（現在は非表示のため存在チェック）
                const keyTd2 = tr.querySelector('td[data-col="会社キー"]');
                const officeKeyTd2 = tr.querySelector('td[data-col="拠点キー"]');
                if(keyTd2) keyTd2.textContent = record['会社キー'] || '';
                if(officeKeyTd2) officeKeyTd2.textContent = record['拠点キー'] || '';
                td.textContent = ''; // セルの内容をクリア
                return; // 変更フラグを設定しない
              }
            }
            
            // 変更フラグを設定
            dbIsDirty = true;
          }
        } else {
          // その他の列も変更フラグを設定
          const record = DB.records[rowIdx];
          if (record && typeof record === 'object') {
            record[col] = newValue;
            dbIsDirty = true;
          }
        }
      });
    });
  });
}

document.getElementById('db-edit').addEventListener('click', async ()=>{
  // 編集モードから閲覧モードに戻る場合
  if(editable){
    // 保存されていない変更があるかチェック
    if(dbIsDirty){
      if(!confirm('保存しないで終了してよろしいですか？')){
        return; // キャンセルされた場合は何もしない
      }
    }
    // 編集モードを終了
    editable = false;
    renderTable();
    updateEditModeUI(false);
    // ボタンテキストを変更
    document.getElementById('db-edit').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>編集開始';
  } else {
    // 閲覧モードから編集モードに移行
    editable = true;
    renderTable();
    updateEditModeUI(true);
    // ボタンテキストを変更
    document.getElementById('db-edit').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>編集終了';
  }
});

function updateEditModeUI(editMode){
  const modeIndicator = document.getElementById('mode-indicator');
  const saveBtn = document.getElementById('db-save');
  const addAboveBtn = document.getElementById('db-add-above');
  const addBtn = document.getElementById('db-add');
  const delBtn = document.getElementById('db-del');
  
  if(editMode){
    modeIndicator.textContent = '編集モード';
    modeIndicator.style.color = '#10b981';
    modeIndicator.style.borderColor = '#10b981';
    modeIndicator.style.background = '#f0fdf4';
    
    // ボタンを有効化
    saveBtn.disabled = false;
    saveBtn.style.background = '#3b82f6';
    saveBtn.style.cursor = 'pointer';
    saveBtn.style.opacity = '1';
    
    addAboveBtn.disabled = false;
    addAboveBtn.style.background = '#10b981';
    addAboveBtn.style.cursor = 'pointer';
    addAboveBtn.style.opacity = '1';
    
    addBtn.disabled = false;
    addBtn.style.background = '#10b981';
    addBtn.style.cursor = 'pointer';
    addBtn.style.opacity = '1';
    
    delBtn.disabled = false;
    delBtn.style.background = '#10b981';
    delBtn.style.cursor = 'pointer';
    delBtn.style.opacity = '1';
  } else {
    modeIndicator.textContent = '閲覧モード';
    modeIndicator.style.color = '#3b82f6';
    modeIndicator.style.borderColor = '#e2e8f0';
    modeIndicator.style.background = '#f8fafc';
    
    // ボタンを無効化
    saveBtn.disabled = true;
    saveBtn.style.background = '#94a3b8';
    saveBtn.style.cursor = 'not-allowed';
    saveBtn.style.opacity = '0.6';
    
    addAboveBtn.disabled = true;
    addAboveBtn.style.background = '#94a3b8';
    addAboveBtn.style.cursor = 'not-allowed';
    addAboveBtn.style.opacity = '0.6';
    
    addBtn.disabled = true;
    addBtn.style.background = '#94a3b8';
    addBtn.style.cursor = 'not-allowed';
    addBtn.style.opacity = '0.6';
    
    delBtn.disabled = true;
    delBtn.style.background = '#94a3b8';
    delBtn.style.cursor = 'not-allowed';
    delBtn.style.opacity = '0.6';
    
    // 変更フラグをクリア
    dbIsDirty = false;
  }
}
document.getElementById('db-add-above').addEventListener('click', ()=>{
  if(!editable){ alert('編集開始を押してください'); return; }
  if(!selectedRow){ alert('行を選択してください'); return; }
  const idx = parseInt(selectedRow.dataset.idx, 10);
  const empty = Object.fromEntries(DB.headers.map(h=>[h,'']));
  DB.records.splice(idx, 0, empty); 
  selectedRow = null; 
  dbIsDirty = true; // 変更を記録
  renderTable();
});
document.getElementById('db-add').addEventListener('click', ()=>{
  if(!editable){ alert('編集開始を押してください'); return; }
  const empty = Object.fromEntries(DB.headers.map(h=>[h,'']));
  DB.records.push(empty); 
  dbIsDirty = true; // 変更を記録
  renderTable();
});
document.getElementById('db-del').addEventListener('click', ()=>{
  if(!editable){ alert('編集開始を押してください'); return; }
  if(!selectedRow){ alert('削除する行を選択してください'); return; }
  if(!confirm('選択行を削除します。よろしいですか？')) return;
  const idx = parseInt(selectedRow.dataset.idx, 10);
  DB.records.splice(idx, 1); 
  selectedRow = null; 
  dbIsDirty = true; // 変更を記録
  renderTable();
});
document.getElementById('db-save').addEventListener('click', async ()=>{
  if(!editable){ alert('編集開始を押してください'); return; }
  const rows = Array.from(document.querySelectorAll('#db-table tbody tr'));

  // テーブルからオブジェクトを再構築（非表示のキー列は既存値を保持）
  const nextRecords = rows.map((tr, idx)=>{
    const tds = Array.from(tr.querySelectorAll('td'));
    const obj = {};
    tds.forEach(td=> obj[td.dataset.col] = td.textContent.trim());
    // 裏で保持しているキー列を維持
    obj['会社キー'] = (DB.records[idx]?.['会社キー'] ?? '');
    obj['拠点キー'] = (DB.records[idx]?.['拠点キー'] ?? '');
    return obj;
  });

  // 行ごとの合計一致バリデーション
  function toInt(v){
    const n = parseInt(String(v ?? '').replace(/[^\d-]/g,''),10);
    return isNaN(n) ? 0 : n;
  }
  const typeCols = ['普通','小型','けん引','被けん引'];
  const weightCols = ['2.0トンまで','2.0トンロング','2.0トンロング超～7.5トンまで','7.5トンを超えるもの'];

  // 全行を検証し、不一致をまとめて報告・ハイライト
  const invalidRows = [];
  for(let i=0;i<nextRecords.length;i++){
    const rec = nextRecords[i];
    const tr = rows[i];
    const sumTypes = typeCols.reduce((s,k)=> s + toInt(rec[k]), 0);
    const sumWeights = weightCols.reduce((s,k)=> s + toInt(rec[k]), 0);
    const companyName = (rec['会社名'] || '').trim();
    // 既存の不一致クラスをクリア（編集中も視覚化を維持するためクラスで管理）
    tr.classList.remove('invalid-row');
    // どちらも0のケースは許容（空行）
    if(sumTypes !== sumWeights){
      // 不一致の行をハイライト（薄い水色を継続）
      tr.classList.add('invalid-row');
      invalidRows.push({companyName, sumTypes, sumWeights});
    }
  }

  // 不一致があった場合に一括報告
  if(invalidRows.length > 0){
    const labels = invalidRows.map(r => {
      const label = r.companyName ? `"${r.companyName}"（種別:${r.sumTypes}台 ≠ 積載量別:${r.sumWeights}台）` : `（種別:${r.sumTypes}台 ≠ 積載量別:${r.sumWeights}台）`;
      return label;
    });
    
    // アラートの代わりに、詳細をコンソールに出力してからアラート
    console.error('車両合計数が一致しません:', invalidRows);
    
    // ユーザー向けには簡潔なメッセージ（件数に関わらず同じフォーマット）
    const separator = 'ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー';
    const header = `${invalidRows.length}件の会社で車両合計数が一致しません:`;
    const summary = `${header}\n${separator}\n\n\n${labels.join('\n\n\n')}`;
    
    alert(summary);
    return; // 保存中止
  }

  DB.records = nextRecords;

  try{
    const res = await fetch('/db/save', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(DB)});
    if(!res.ok){ throw new Error(await res.text()); }
    document.getElementById('db-msg').textContent = '保存しました';
    dbIsDirty = false; // 保存完了したのでフラグをクリア
    editable = false; 
    updateEditModeUI(false); // UIを更新してボタン名を"編集開始"に戻す
    document.getElementById('db-edit').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>編集開始';
    await loadDB();
  }catch(e){
    alert('保存に失敗: ' + e.message);
  }
});

// XHRでアップロード進捗を表示しつつPOST→応答Blobを保存
const runBtn = document.getElementById('runBtn');
const upStatus = document.getElementById('upStatus');
const form = document.getElementById('makeForm');

// ZIP signature quick check for .xlsx
async function isZip(file){
  const buf = await file.slice(0,4).arrayBuffer();
  const u = new Uint8Array(buf);
  return u[0]===0x50 && u[1]===0x4B && u[2]===0x03 && u[3]===0x04; // 'PK\x03\x04'
}

runBtn.addEventListener('click', async ()=>{

  const fd = new FormData();
  const upStatus = document.getElementById('upStatus');
  
  // ストアからファイルと回答データを取得
  const incFiles = Array.from(_incStore);
  const decFiles = Array.from(_decStore);
  const allFiles = [...incFiles, ...decFiles];
  
  if(allFiles.length === 0){
    upStatus.textContent = 'ファイルをアップロードしてください。';
    return;
  }
  
  // .xlsx quick validation to prevent non-Excel uploads
  for(const f of allFiles){
    if(!(await isZip(f))){ 
      upStatus.textContent = '失敗: Excel(.xlsx)以外の可能性があります。'; 
      return; 
    }
  }
  
  // 回答データを収集
  const fileAnswers = [];
  allFiles.forEach((file, index) => {
    const carTypeRadio = document.querySelector(`input[name="car_type_${index}"]:checked`);
    const weightSelect = document.querySelector(`select[name="weight_class_${index}"]`);
    
    // ファイルの種類は元のアップロード時の分類を使用
    const fileType = incFiles.includes(file) ? 'increase' : 'decrease';
    
    fileAnswers.push({
      file: file,
      fileType: fileType,
      carType: carTypeRadio ? carTypeRadio.value : '普通',
      weightClass: weightSelect ? weightSelect.value : 'to_2t'
    });
  });
  
  // FormDataに追加
  let incIndex = 0;
  let decIndex = 0;
  
  fileAnswers.forEach((answer, index) => {
    if(answer.fileType === 'increase'){
      fd.append('increase_files', answer.file);
      fd.append(`inc_car_type_${incIndex}`, answer.carType);
      fd.append(`inc_weight_class_${incIndex}`, answer.weightClass);
      incIndex++;
    } else {
      fd.append('decrease_files', answer.file);
      fd.append(`dec_car_type_${decIndex}`, answer.carType);
      fd.append(`dec_weight_class_${decIndex}`, answer.weightClass);
      decIndex++;
    }
  });

  runBtn.disabled = true;
  upStatus.innerHTML = '<span class="spinner"></span><span class="progress" id="prog">処理中…</span>';

  try{
    const blob = await xhrPostWithProgress('/process', fd, (percent)=>{
      const p = document.getElementById('prog');
      p.textContent = `処理中… ${percent}%`;
    });
    const fname = '事業計画変更届出.xlsx';
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = fname;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    
    // ファイル選択をリセット
    resetUploadsAfterSuccess();
    
    upStatus.textContent = '処理が完了しました。ファイルをダウンロードしました。';
    
    // ダウンロード成功後にファイルをクリア
    _incStore.length = 0;
    _decStore.length = 0;
    _questionAnswered = false;
    
    // ファイルリストをクリア
    const incList = document.getElementById('incList');
    const decList = document.getElementById('decList');
    if(incList) incList.innerHTML = '';
    if(decList) decList.innerHTML = '';
    
    // カウント表示をクリア
    const incCount = document.getElementById('incCount');
    const decCount = document.getElementById('decCount');
    if(incCount) incCount.textContent = '';
    if(decCount) decCount.textContent = '';
    
    // ボタンの状態を更新
    updateRunButtonState();
    updateAnswerQuestionsButtonState();
    
  }catch(e){
    upStatus.textContent = '失敗: ' + e.message;
  }finally{
    runBtn.disabled = false;
  }
});

function xhrPostWithProgress(url, formData, onProgress){
  return new Promise((resolve, reject)=>{
    const xhr = new XMLHttpRequest();
    xhr.open('POST', url);
    xhr.responseType = 'blob';
    xhr.upload.onprogress = (e)=>{
      if(e.lengthComputable && typeof onProgress === 'function'){
        const percent = Math.min(99, Math.round(e.loaded / e.total * 100));
        onProgress(percent);
      }
    };
    xhr.onload = ()=>{
      if(xhr.status >= 200 && xhr.status < 300){
        resolve(xhr.response);
      }else{
        // エラーレスポンスをテキストとして読み取り
        const reader = new FileReader();
        reader.onload = ()=> {
          try {
            // JSONレスポンスの場合
            const responseText = reader.result;
            const jsonResponse = JSON.parse(responseText);
            if(jsonResponse.error) {
              reject(new Error(jsonResponse.error));
            } else {
              reject(new Error(responseText || ('HTTP '+xhr.status)));
            }
          } catch (e) {
            // JSONでない場合はそのまま表示
            reject(new Error(reader.result || ('HTTP '+xhr.status)));
          }
        };
        reader.readAsText(xhr.response);
      }
    };
    xhr.onerror = ()=> reject(new Error('ネットワークエラー'));
    xhr.send(formData);
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  const incWeight = document.getElementById('incWeight');
  const decHidden = document.getElementById('decWeightHidden');
  if(incWeight && decHidden){
    const sync = ()=>{ decHidden.value = incWeight.value; };
    incWeight.addEventListener('change', sync);
    sync();
  }
});

</script>
