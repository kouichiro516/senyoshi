# 計画届作成アプリ — 技術仕様書（完全版）

本書は、**現行実装を再現できるレベル**で要件・仕様・画面・データ・処理フロー・エラー動作をまとめたものです。  
ここに記載されたとおりに実装すれば、現在稼働中と**同じクオリティ**で構築できます。

---

## 0. 用語
- **連絡書**: 入力Excel（.xlsx）。増車/減車の情報が記載された社内フォーム。
- **申請書テンプレ**: `templates_src/申請書共通.xlsx`（別紙のベース）。
- **本紙テンプレ**: `templates_src/申請書増車1.xlsx`、`templates_src/申請書減車1.xlsx`、または `templates_src/申請書増減1.xlsx`（出力ブックのシート1）。
- **DB**: `counter.json`（ヘッダ＋レコードの2段構造または `area_table` 内に同構造）

---

## 1. 目的と前提
- 目的: 連絡書（.xlsx）をアップロード → **申請書（出力Excel）を自動生成**。同時に DB の**種別**・**積載トン数**のカウントを更新。
- 前提: **1連絡書 = 1営業所**。1回の実行では**同一会社・同一営業所**のみ許可。  
- 仕様: 増車のみ、減車のみ、または**増減混在**のアップロードが可能。未選択はエラー。

---

## 2. システム構成
- バックエンド: Flask（`app.py`）
- フロント: 単一HTML（`index.html`）+ 素のJS/CSS
- データ: JSON（`counter.json`）
- Excel操作: openpyxl（テンプレ複写・書き込み・シート複合）

ディレクトリ:
```
<app>/
├─ app.py                      # Flask本体。SRC=ROOT/"templates_src" を前提にパス解決
├─ counter.json                # DB（area_table or headers+records）
├─ templates/                  # ← Flaskの慣習に合わせる場合（推奨）
│   └─ index.html              # フロント。/ で返す
├─ templates_src/              # Excelテンプレ格納ディレクトリ（必須・名前固定）
│   ├─ 申請書共通.xlsx         # 別紙のベース（生成元）
│   ├─ 申請書増車1.xlsx        # 本紙テンプレ（増車のみ）
│   ├─ 申請書減車1.xlsx        # 本紙テンプレ（減車のみ）
│   └─ 申請書増減1.xlsx        # 本紙テンプレ（増減混在）  
├─ static/       
│   └─ style.css
└─ (生成物は保存しない)        # send_fileで都度返却。ローカルに残さない前提

---

## 3. 画面仕様（index.html）

### 3.1 タブ
- **作成** / **DB** の2タブ。初期は「作成」。

### 3.2 作成タブ
- **① 連絡書（増車）枠** / **② 連絡書（減車）枠**
  - D&D またはクリック選択。**複数ファイル**可。増車と減車の**同時アップロードも可能**（増減混在）。
  - ファイルアップロード後、**Lucideアイコン（FileText）**でファイルチップを表示。各チップ右上の**×**で個別削除。
  - **ファイル重複チェック**: 同一セクション（増車または減車）内で、`name`、`size`、`lastModified`が全て同じファイルは重複として検出し、アラート表示。重複ファイルは追加されない。
- **③ 質問に答えるボタン**
  - ファイルアップロード後、モーダル画面で各ファイルの詳細を入力。
  - モーダル画面では各ファイルに対して以下を選択:
    - **種別**（ラジオ）: 普通 / 小型 / けん引 / 被けん引
    - **積載トン数**（セレクト）:
      - `to_2t` → 2.0トンまで  
      - `2t_long` → 2.0トンロング  
      - `over_2t_long_to_7_5t` → 2.0トンロング超～ 7.5トンまで  
      - `over_7_5t` → 7.5トンを超えるもの
  - モーダル内の「減車」ラベルは赤背景（`#fee2e2`）で表示。
- **④ 実行ボタン**
  - 送信前に .xlsx のZipシグネチャを簡易検証。
  - `FormData(form)` をそのまま送信（**重複appendなし**）。
  - **成功ダウンロード直後**に、選択ファイル・アイコン・件数表示を**自動クリア**（失敗時は保持）。

### 3.3 DBタブ
- `GET /db` で取得した `counter.json` を**表**で表示・編集・保存・CSV出力。
- **表記ゆれ吸収**レイヤにより、ヘッダとレコードキーが `2.0` / `2 . 0` / 全角スペース混在でも**正しく表示**。
- **行番号列**: テーブルの最左列に行番号（1から開始）を表示。ヘッダーなし。
- **編集モード**:
  - **編集開始**ボタン: 閲覧モードから編集モードに切り替え。セルをクリックで編集可能。
  - **編集終了**ボタン: 編集モードを終了し、変更を保存。
- **キーバインド**（編集モード時）:
  - **Enter**: 下のセルに移動
  - **Shift+Enter**: 上のセルに移動
  - **Alt+Enter**: セル内で改行
  - セル移動時に選択行の緑枠も連動して移動。
- **ツールバーボタン**（Lucideアイコン使用）:
  - **編集開始/終了**: FileTextアイコン（編集開始時）またはXアイコン（編集終了時）
  - **保存**: Saveアイコン（編集モード時のみ有効）
  - **選択行の上に行を追加**: Plusアイコン（編集モード時のみ有効）
  - **一番下に行を追加**: Plusアイコン（編集モード時のみ有効）
  - **選択行を削除**: Minusアイコン（編集モード時のみ有効）
  - **CSV**: Downloadアイコン（常時有効）
- **CSV出力**: `GET /db/csv` でCSVファイルをダウンロード。
  - 出力列: A列（会社名）、B列（営業所所在地）、C列（本社/営業所/支店）、D列（合計）、E列（EQ）、F列（シャーシ）
  - D列「合計」: 普通 + 小型 + けん引 + 被けん引
  - E列「EQ」: 普通 + 小型 + けん引
  - F列「シャーシ」: 被けん引
  - UTF-8 BOM付きで文字化けを防止。

---

## 4. サーバ仕様（app.py）

### 4.1 ルート
- `GET /` : index.html 返却
- `GET /db` : DB（headers+records）を返却。`area_table` があればその中を優先。
- `POST /db/save` : DB（headers+records）を保存。
- `GET /db/csv` : DBをCSV形式でダウンロード（計算列付き、UTF-8 BOM付き）。
- `POST /process` : 申請書生成 & DB更新 & 本紙合体 & ダウンロード

### 4.2 /process 入出力
- 入力（multipart/form-data）
  - `increase_files[]`（増車 .xlsx 複数）
  - `decrease_files[]`（減車 .xlsx 複数）
  - `car_type`（普通/小型/けん引/被けん引）
  - `inc_weight_class` / `dec_weight_class`（未指定時はincで代用）
- 出力
  - `Content-Disposition: attachment` で xlsx を返却

### 4.3 入力ガード
- ファイル重複除去 `_uniq_files()`（ファイル名＋サイズ相当）。
- **未選択禁止**: 両方とも空 → **400**（アラート）。
- **1社1拠点チェック**: 会社名・営業所名が混在 → **400**（アラート）。
- **減車不足**: 減算でカウントが負になる → **409**。
- **クライアント側ファイル重複チェック**: 同一セクション（増車または減車）内で、`name`、`size`、`lastModified`が全て同じファイルを検出し、アラート表示。重複ファイルは追加されない。

### 4.4 DB更新
- **対象行の特定**: 会社名＋営業所名で一致するレコードに対して更新。  
- **種別カウント**: 選択された `car_type` 列を、増車で +件数、減車で −件数。
- **積載トン数カウント**: 
  - UI値 → DB列名の対応表で ±（増車/減車の**ファイル件数**）。  
  - DB列名の突き合わせは**正規化**（空白/全角スペース/ドット/中黒除去）で**表記ゆれ吸収**。

| UI値 | DB列名 |
|---|---|
| `to_2t` | 2.0トンまで |
| `2t_long` | 2.0トンロング |
| `over_2t_long_to_7_5t` | 2.0トンロング超～ 7.5トンまで |
| `over_7_5t` | 7.5トンを超えるもの |

### 4.5 申請書Excelの生成（別紙）
- ベース: `templates_src/申請書共通.xlsx` を複写して作業ファイルを作成。
- 転記仕様（先頭シート固定）
  - **B21**: 営業所名（5行目と同ロジックの抽出元）
  - **C/Mブロック（21～25行）**:
    - **1～5件目 → C列**, **6～10件目 → M列**
    - **増車**: 同セル内の **「減車」関連の文字列**を削除  
      **減車**: 同セル内の **「増車」関連の文字列**を削除
  - **F21～F25**: 最大積載量（**整数 + 半角スペース + `kg`**）  
    - 増車: 連絡書 **U23** / 減車: **AQ23**
  - **H/R21～H/R25**: 年式（例：H27/R05）  
    - 増車: 元号 **R19 (H/R)** + 数値 **U19**  
    - 減車: 元号 **AM19 (H/R)** + 数値 **AQ19**
  - **L30～L33**: DBの**重量別カウント（増減反映後）**を転記  
    - 対応は **B30～B33 のラベル文字**を読み取り、表記ゆれ吸収でDBキーと突き合わせて L列へ整数書込。

### 4.6 本紙の追加（シート複合）
- 「別紙」（上記で生成したシート）を**シート2**にリネーム。  
- 先頭に**シート1「本紙」**を追加して、**同じブック**で保存。
  - 増車のみ: `templates_src/申請書増車1.xlsx`  
  - 減車のみ: `templates_src/申請書減車1.xlsx`
  - **増減混在**: `templates_src/申請書増減1.xlsx`
- コピーは**値＋基本書式（フォント/罫線/塗り/配置/保護/番号形式）＋列幅/行高/結合/フリーズ/一部のページ設定**を持ち込み。  
  （図形・フォームコントロール等は対象外）

---

## 5. DB仕様（counter.json）
- 構造:  
  - `{"headers": [...], "records": [ {列名: 値, ...}, ... ]}`  または  
  - `{"area_table": {"headers": [...], "records": [...]}}`
- 必須列:  
  - **拠点キー**（会社名 / 営業所種別 / 営業所名など、現行DBに合わせる）  
  - **種別**（普通 / 小型 / けん引 / 被けん引）  
  - **重量（4列）**  
    - `2.0トンまで` / `2.0トンロング` / `2.0トンロング超～ 7.5トンまで` / `7.5トンを超えるもの`
- 表示・更新ともに**表記ゆれ吸収**を実装済み。

---

## 6. エラーと応答
| 条件 | ステータス | 表示 |
|---|---|---|
| 増車・減車が**未選択** | 400 | アラート |
| 会社名/営業所名が**混在** | 400 | アラート |
| 減車で**不足**（負数） | 409 | アラート |
| テンプレが**開いたまま** | 500 | Internal Server Error |
| DBタブが**真っ白** | - | `http://127.0.0.1:5000/` で開く（`file://`直開きは不可） |
| **ファイル重複**（クライアント側） | - | アラート「同じファイルがアップロードされています」 |

---

## 7. 実行手順
1. 依存（Python 3.11 / Flask / openpyxl 等）をインストール。
2. テンプレExcel（4つ）を **閉じた状態**で `templates_src/` に配置。
   - `申請書共通.xlsx`
   - `申請書増車1.xlsx`
   - `申請書減車1.xlsx`
   - `申請書増減1.xlsx`
3. サーバ起動: `python app.py`  
4. ブラウザで `http://127.0.0.1:5000/` を開く。
5. 作成タブでアップロード → **質問に答える**（モーダルで各ファイルの詳細を入力）→ 実行。  
   成功するとダウンロード、**選択は自動クリア**。  
6. DBタブで結果確認・編集・保存・CSV出力。

---

## 8. テスト観点（最低限）
- 増車のみ / 減車のみ / **増減混在**（全て正常に処理されること）
- 種別4種 × 重量4区分
- 1～5件C列 / 6～10件M列 の配分・不要語削除
- F列「数値 + 半角スペース + kg」
- H/R列 年式表記（Hxx/Rxx）
- L30～L33 にDBの重量カウントが入る
- 本紙（シート1）+ 別紙（シート2）の2シート構成
  - 増車のみ → `申請書増車1.xlsx`
  - 減車のみ → `申請書減車1.xlsx`
  - 増減混在 → `申請書増減1.xlsx`
- DBタブ表示が `counter.json` と一致（表記ゆれ吸収が効く）
- DBタブの編集機能（行追加/削除、セル編集、キーバインド）
- CSV出力（計算列の正確性、UTF-8 BOM付き）
- ファイル重複チェック（name, size, lastModified）
- 成功後に選択が自動クリアされる

---

## 9. 実装の要点（抜粋）
- **増減混在対応**: 増車と減車の同時アップロードが可能。テンプレートは`申請書増減1.xlsx`を使用。
- **未選択禁止**のガード。
- **重複ファイル除去**（FileListの二重送信対策）と**クライアント側重複チェック**（name, size, lastModified）。
- **モーダル画面**: ファイルアップロード後、各ファイルの種別・積載トン数を個別に設定。
- **DBキー正規化**（空白/全角スペース/ドット/中黒除去）で表示・更新の両方を安定化。
- **Excelシート複合**は openpyxl で**値＋基本書式**をコピー（画像や図形は対象外）。
- **DBタブ編集機能**: 編集モード、行追加/削除、Excelライクなキーバインド（Enter/Shift+Enter/Alt+Enter）。
- **CSV出力**: 計算列（合計、EQ、シャーシ）を含むUTF-8 BOM付きCSV。
- **UIアイコン**: Lucide SVGアイコンを使用（FileText、Database、Save、Plus、Minus、Download等）。
- **成功時のみ**アップロード選択を初期化（失敗時は保持）。

---

## 10. 既知の注意点
- Excelテンプレは**開いたままにしない**（Windowsのロックで保存失敗）。
- ブラウザで直接 `index.html` を開く（`file://`）と DB タブは取得失敗になる。**必ず Flask 経由**。
- `counter.json` の列名変更は、ヘッダとレコードキーの**一貫性**を保つ。

---

## 付録 A. UI値とDB列名の正規化例
- `2.0トンまで` ↔ `2 . 0 トンまで`
- `2.0トンロング超～ 7.5トンまで` ↔ `2 . 0 トンロング超～ 7 . 5 トンまで`

---

## 付録 B. 主要セル対応表（申請書）
| 目的 | セル |
|---|---|
| 営業所名 | B21 |
| 台帳（1～5件） | C21～C25 |
| 台帳（6～10件） | M21～M25 |
| 最大積載量 | F21～F25（整数＋半角スペース＋kg） |
| 年式（前半） | H21～H25 |
| 年式（後半） | R21～R25 |
| 重量別合計（DB） | L30～L33（B30～B33ラベルに対応） |
